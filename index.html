<!DOCTYPE html>
<html>
<head>
  <title>Dynamic To-Do Tabs üòé</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --default-moving: linear-gradient(135deg, #5b00ff, #ff0066, #00f2ff); }

    body {
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      padding: 40px;
      transition: background 0.6s ease;
      background: var(--default-moving);
      background-size: 400% 400%;
      animation: gradientMove 12s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .hidden { display: none; }
    input, button, select { padding: 10px; margin: 6px; border-radius: 8px; border: none; font-size: 15px; }
    button { cursor: pointer; }
    .list-button { background-color: white; color: #6b5bff; }

    ul { list-style: none; padding: 0; margin-top: 10px; }
    li { margin: 10px; background: rgba(255,255,255,0.14); padding: 12px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    input[type="text"] { flex: 1; margin-left: 10px; border-radius:6px; padding:8px; border:none; }

    .gradient-option { width: 86px; height: 44px; border-radius: 10px; display: inline-block; margin: 6px; cursor: pointer; border: 3px solid transparent; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .gradient-option.selected { border-color: white; transform: translateY(-3px); }

    .tabs { margin-bottom: 18px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .tab-btn { background: rgba(255,255,255,0.12); color: white; border-radius: 12px; padding: 8px 12px; cursor: pointer; display:inline-flex; align-items:center; gap:6px; border: none; }
    .tab-btn.active { background: white; color: #6b5bff; font-weight:600; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }

    .control-small { padding:6px 8px; font-size:14px; border-radius:8px; }
    .small-btn { padding:6px 10px; font-size:13px; border-radius:6px; cursor:pointer; }

    #topPanels {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: calc(100% - 80px);
      margin: 0 auto 18px auto;
      box-sizing: border-box;
      max-width: 1200px;
    }

    .panel {
      width: 100%;
      background: rgba(0, 0, 0, 0.32);
      border-radius: 12px;
      color: white;
      text-align: left;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      overflow: visible;
    }

    .panel-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      border-radius: 12px;
      background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02));
      font-weight: 600;
      gap:8px;
    }
    .panel-header .title { text-align:center; flex:1; font-size:16px; }
    .chev { width:20px; height:20px; display:inline-block; transition: transform 220ms ease; }

    .panel-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height 320ms cubic-bezier(.25,.8,.25,1), padding 220ms ease;
      padding: 0 12px;
    }
    .panel-body.open { padding: 12px; }
    .open .chev { transform: rotate(180deg); }

    #quickLinksList { padding-left: 6px; max-height: 240px; overflow-y: auto; margin-bottom: 8px; }
    #quickLinksList li { display:flex; justify-content: space-between; align-items: center; gap:8px; margin-bottom:6px; font-size:14px; }
    #quickLinksList a { color: #ffd; text-decoration: underline; max-width: 160px; word-break: break-word; }

    #plannerGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 8px;
      box-sizing: border-box;
    }
    .day-col {
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      min-height: 120px;
      padding: 8px;
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .day-header { font-weight:700; font-size:13px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .task-pill { display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius: 8px; color: #071019; font-size:13px; justify-content:space-between; }
    .task-label { flex:1; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-right:6px; }

    /* ===== MONTHLY CALENDAR ===== */
    #monthlyGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 8px;
    }
    .month-day-header { font-weight: 700; font-size: 11px; text-align: center; padding: 4px; opacity: 0.8; }
    .month-day {
      background: rgba(255,255,255,0.06);
      border-radius: 6px;
      min-height: 60px;
      padding: 4px;
      font-size: 10px;
    }
    .month-day.other-month { opacity: 0.4; }
    .month-day.today { border: 2px solid #1DB954; }
    .month-day-num { font-weight: 700; font-size: 11px; margin-bottom: 2px; }
    .month-task { background: rgba(255,255,255,0.2); border-radius: 3px; padding: 2px 4px; margin-top: 2px; font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    #palette { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .palette-row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .swatch { width:34px; height:34px; border-radius:6px; border:2px solid rgba(255,255,255,0.18); cursor:pointer; display:inline-block; box-shadow:0 4px 10px rgba(0,0,0,0.18); }
    .swatch.selected { outline:3px solid rgba(255,255,255,0.12); transform:translateY(-2px); }
    .swatch-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .swatch-label { color: white; font-size: 10px; max-width: 50px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    #addColorForm { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #addColorForm input[type="text"] { width:140px; padding:8px; border-radius:8px; }

    /* ===== DASHBOARD PANEL (Horizontal Layout) ===== */
    #leftPanel { width: 100%; }
    .dashboard-content {
      display: flex;
      flex-direction: row;
      gap: 12px;
      padding: 12px;
      align-items: stretch;
    }

    /* ===== VIRTUAL PET IN PANEL ===== */
    #petBox {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      flex: 1;
      min-width: 140px;
    }
    #petDisplay { font-size: 40px; line-height: 1; margin-bottom: 4px; position: relative; display: inline-block; }
    #petAccessory { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 20px; }
    #petName { font-size: 13px; font-weight: bold; margin-bottom: 2px; }
    #petLevel { font-size: 10px; opacity: 0.8; margin-bottom: 4px; }
    #happinessBar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
    #happinessFill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcb77); transition: width 0.5s ease; }
    #petMood { font-size: 10px; margin-top: 4px; }
    #tasksToday { font-size: 9px; opacity: 0.7; margin-top: 2px; }
    #unlockedPets { font-size: 9px; opacity: 0.7; margin-top: 2px; }
    .pet-bounce { animation: petBounce 0.5s ease; }
    @keyframes petBounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes petSad { 0%,100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
    .pet-sad { animation: petSad 1s ease infinite; }

    /* ===== QUOTE BOX IN PANEL ===== */
    #quoteBox {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
      font-style: italic;
      position: relative;
      text-align: left;
      flex: 1.5;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    #quoteText { font-size: 12px; line-height: 1.4; margin-bottom: 6px; }
    #quoteAuthor { font-size: 11px; opacity: 0.7; }
    #newQuoteBtn { position: absolute; top: 6px; right: 6px; padding: 3px 6px; font-size: 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; color: white; }

    /* ===== TIMER IN PANEL ===== */
    #timerBox {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      flex: 1;
      min-width: 140px;
    }
    #timerTitle { font-weight: 600; font-size: 12px; margin-bottom: 4px; }
    #timerDisplay { font-size: 24px; font-weight: bold; font-family: monospace; margin: 4px 0; }
    #timerProgress { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; margin-bottom: 6px; }
    #timerProgressFill { height: 100%; background: #1DB954; transition: width 1s linear; }
    .timer-btn { padding: 4px 8px; margin: 2px; font-size: 10px; border-radius: 5px; border: none; cursor: pointer; }
    .timer-btn.start { background: #1DB954; color: white; }
    .timer-btn.pause { background: #ffd93d; color: #333; }
    .timer-btn.reset { background: rgba(255,255,255,0.2); color: white; }

    /* ===== QUICK LINKS BUTTON ===== */
    #quickLinksBtn { 
      background: rgba(255,255,255,0.15); 
      border: none; 
      padding: 8px 12px; 
      border-radius: 8px; 
      cursor: pointer; 
      color: white;
      font-size: 12px;
      margin-top: 8px;
    }
    #quickLinksBtn:hover { background: rgba(255,255,255,0.25); }

    /* ===== QUICK LINKS MODAL ===== */
    #quickLinksModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(6,8,12,0.95);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      width: 350px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }
    #quickLinksModal h3 { margin-top: 0; }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    /* ===== TASK WITH TIME ESTIMATE ===== */
    .task-row {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }
    .task-timer-section {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.2);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }
    .task-time-display { font-family: monospace; min-width: 55px; font-weight: bold; }
    .task-start-btn {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1DB954;
      color: white;
    }
    .task-start-btn.running {
      background: #ff6b6b;
    }
    .task-start-btn:hover { opacity: 0.9; }
    .task-estimate { font-size: 10px; opacity: 0.7; }

    @media (max-width: 880px) {
      #topPanels { gap: 12px; width: calc(100% - 40px); }
      .panel { width: 100%; }
      body { padding: 20px; }
      #plannerGrid { grid-template-columns: repeat(1, 1fr); }
      .dashboard-content { flex-wrap: wrap; }
      #petBox, #quoteBox, #timerBox { min-width: 120px; flex: 1 1 45%; }
    }

    @media (max-width: 600px) {
      .dashboard-content { flex-direction: column; }
      #petBox, #quoteBox, #timerBox { width: 100%; flex: none; }
    }

    #plannerBody { max-width: 100%; overflow-x: auto; overflow-y: hidden; }
  </style>
</head>
<body>

  <!-- Sign up / Login -->
  <div id="signup">
    <h1>Sign Up üí´</h1>
    <input type="text" id="username" placeholder="Enter a username"><br>
    <input type="password" id="password" placeholder="Enter a password"><br>
    <p style="margin-top:8px">Pick your background style (or keep the moving default):</p>
    <div id="gradients">
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff7e5f, #feb47b)" style="background: linear-gradient(to right, #ff7e5f, #feb47b)" title="Sunset"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #2193b0, #6dd5ed)" style="background: linear-gradient(to right, #2193b0, #6dd5ed)" title="Ocean"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #0f2027, #203a43, #2c5364)" style="background: linear-gradient(to right, #0f2027, #203a43, #2c5364)" title="Galaxy"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff9a9e, #fad0c4)" style="background: linear-gradient(to right, #ff9a9e, #fad0c4)" title="Blossom"></div>
      <div class="gradient-option" data-bg="default" id="defaultOption" style="background: linear-gradient(135deg,#5b00ff,#ff0066,#00f2ff)" title="Keep moving gradient"></div>
    </div>
    <div style="margin-top:8px">
      <button onclick="createAccount()">Create Account</button>
      <button class="control-small" onclick="useDefaultNow()">Don't change ‚Äî keep moving</button>
    </div>
    <p style="margin-top:12px">Already have an account? <a href="#" onclick="showLogin()">Log in</a></p>
  </div>

  <div id="login" class="hidden">
    <h1>Login üí´</h1>
    <input type="text" id="loginUsername" placeholder="Enter username"><br>
    <input type="password" id="loginPassword" placeholder="Enter password"><br>
    <div style="margin-top:8px">
      <button onclick="login()">Log In</button>
      <button class="control-small" onclick="showSignup()">Sign up</button>
    </div>
  </div>

  <!-- Top panels: Dashboard (horizontal) + Planner -->
  <div id="topPanels" class="hidden" aria-hidden="true">
    <!-- Dashboard Panel: Pet, Quote, Timer (horizontal) -->
    <div id="leftPanel" class="panel">
      <div class="panel-header" onclick="togglePanel('leftPanel')">
        <div style="width:20px"></div>
        <div class="title">Dashboard</div>
        <div class="chev">‚ñæ</div>
      </div>
      <div id="leftPanelBody" class="panel-body">
        <div class="dashboard-content">
          <!-- Pet -->
          <div id="petBox">
            <div id="petDisplay"><span id="petAccessory"></span><span id="petEmoji">üê±</span></div>
            <div id="petName">Pixel</div>
            <div id="petLevel">Level 1 ‚Ä¢ 0 XP</div>
            <div id="happinessBar"><div id="happinessFill" style="width: 50%"></div></div>
            <div id="petMood">üòê Waiting for tasks...</div>
            <div id="tasksToday">Tasks today: 0/5</div>
            <div id="unlockedPets">üîì 1/10 pets</div>
            <button class="small-btn" onclick="openPetSettings()" style="margin-top:8px; font-size:11px; padding:6px 10px;">‚öôÔ∏è Settings</button>
          </div>

          <!-- Quote -->
          <div id="quoteBox">
            <button id="newQuoteBtn" onclick="showNewQuote()">üîÑ</button>
            <div id="quoteText">"Loading wisdom..."</div>
            <div id="quoteAuthor">‚Äî Loading</div>
          </div>

          <!-- Timer -->
          <div id="timerBox">
            <div id="timerTitle">‚è±Ô∏è Focus Timer</div>
            <div id="timerProgress"><div id="timerProgressFill" style="width: 100%"></div></div>
            <div id="timerDisplay">25:00</div>
            <div>
              <input type="number" id="timerMinutes" value="25" min="1" max="120" style="width:45px; text-align:center; padding:4px; font-size:12px;"> min
            </div>
            <div style="margin-top:4px;">
              <button class="timer-btn start" onclick="startTimer()">‚ñ∂</button>
              <button class="timer-btn pause" onclick="pauseTimer()">‚è∏</button>
              <button class="timer-btn reset" onclick="resetTimer()">‚Ü∫</button>
            </div>
          </div>

          <!-- Journal & Quick Links Buttons -->
          <div style="display:flex; flex-direction:column; gap:8px; align-items:center;">
            <button id="journalBtn" onclick="openJournalModal()" style="padding:10px 14px; width:100%;">üìì Journal</button>
            <button id="quickLinksBtn" onclick="openQuickLinksModal()" style="padding:10px 14px; width:100%;">üìé Links</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Planner Panel -->
    <div id="planner" class="panel">
      <div class="panel-header" onclick="togglePanel('planner')">
        <div style="width:20px"></div>
        <div class="title">Planner (Weekly)</div>
        <div class="chev">‚ñæ</div>
      </div>
      <div id="plannerBody" class="panel-body">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <select id="plannerViewSelect" onchange="switchPlannerView(this.value)" style="padding:6px; border-radius:6px;">
            <option value="weekly">üìÖ Weekly View</option>
            <option value="monthly">üóìÔ∏è Monthly View</option>
          </select>
          <div id="plannerViewLabel" style="margin-left:auto; font-size:13px; opacity:0.9">Week: Sunday ‚Üí Saturday</div>
        </div>
        <div id="plannerGrid" style="margin-top:10px;"></div>
        <div id="monthlyGrid" class="hidden" style="margin-top:10px;"></div>
        <div id="palette">
          <div style="font-weight:600; margin-top:8px;">Palette (saved colors)</div>
          <div class="palette-row" id="paletteRow"></div>
          <div id="addColorForm" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
            <input type="text" id="paletteLabel" placeholder="Label (e.g. school)">
            <input type="color" id="paletteColor" value="#ffd166">
            <button class="small-btn" onclick="addPaletteColor()">Save color</button>
            <button class="small-btn" onclick="clearPalette()">Clear Palette</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Links Modal -->
  <div id="quickLinksOverlay" class="modal-overlay hidden" onclick="closeQuickLinksModal()"></div>
  <div id="quickLinksModal" class="hidden">
    <h3>üìé Quick Links</h3>
    <ul id="quickLinksList"></ul>
    <div style="margin-top:12px;">
      <input type="text" id="quickLinkName" placeholder="Link name" style="width:100%; margin-bottom:6px;">
      <input type="text" id="quickLinkURL" placeholder="URL (e.g. https://spotify.com)" style="width:100%; margin-bottom:6px;">
      <button class="small-btn" onclick="addQuickLink()">Add Link</button>
      <button class="small-btn" onclick="clearQuickLinks()">Clear All</button>
    </div>
    <button onclick="closeQuickLinksModal()" style="margin-top:12px; width:100%;">Close</button>
  </div>

  <!-- Journal Modal -->
  <div id="journalOverlay" class="modal-overlay hidden" onclick="closeJournalModal()"></div>
  <div id="journalModal" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(6,8,12,0.95); padding:20px; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:400px; max-height:80vh; z-index:1000;">
    <h3 style="margin-top:0;">üìì Journal</h3>
    <textarea id="journalTextarea" placeholder="Write your thoughts here..." style="width:100%; height:300px; border-radius:8px; padding:12px; font-size:14px; resize:vertical; background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.2);"></textarea>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button onclick="closeJournalModal()">Close</button>
      <button onclick="saveJournal()" class="list-button">Save</button>
    </div>
  </div>

  <!-- Task Completion Popup -->
  <div id="taskCompletionPopup" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg, #1DB954, #0d9440); padding:24px 32px; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,0.5); z-index:1001; text-align:center; animation:popIn 0.3s ease;">
    <div style="font-size:32px; margin-bottom:8px;">üéâ</div>
    <div id="completionMessage" style="font-size:18px; font-weight:bold;"></div>
  </div>

  <style>
    @keyframes popIn {
      0% { transform: translate(-50%,-50%) scale(0.5); opacity: 0; }
      70% { transform: translate(-50%,-50%) scale(1.1); }
      100% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
    }
    @keyframes popOut {
      0% { transform: translate(-50%,-50%) scale(1); opacity: 1; }
      100% { transform: translate(-50%,-50%) scale(0.5); opacity: 0; }
    }
    .popup-exit { animation: popOut 0.2s ease forwards; }
    @keyframes spinWheel {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(1800deg); }
    }
    .wheel-spinning { animation: spinWheel 2s cubic-bezier(0.17, 0.67, 0.12, 0.99) forwards; }
  </style>

  <!-- Task Wheel Popup -->
  <div id="taskWheelOverlay" class="modal-overlay hidden" onclick="closeTaskWheel()"></div>
  <div id="taskWheelPopup" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(6,8,12,0.95); padding:24px; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,0.6); z-index:1001; text-align:center; min-width:300px;">
    <div style="font-size:24px; margin-bottom:12px;">üé° Task Wheel</div>
    <div id="wheelEmoji" style="font-size:64px; margin:20px 0;">üéØ</div>
    <div id="wheelResult" style="font-size:16px; padding:12px; background:rgba(255,255,255,0.1); border-radius:8px; margin:12px 0;"></div>
    <div id="wheelListName" style="font-size:12px; opacity:0.7; margin-bottom:12px;"></div>
    <button onclick="closeTaskWheel()" style="margin-top:8px;">Close</button>
  </div>

  <!-- To-do lists -->
  <div id="todo" class="hidden">
    <div id="todoHeader"></div>
    <div class="tabs" id="tabsContainer"></div>
    <div id="listsContainer"></div>
    <div id="background-picker" class="hidden" style="margin-top:12px;">
      <label for="bg-select">Choose Background:</label>
      <select id="bg-select" onchange="changeBackground(this.value)">
        <option value="default">Default</option>
        <option value="blue-purple-moving">Blue Purple (Moving)</option>
        <option value="linear-gradient(to right, #ff7e5f, #feb47b)">Sunset</option>
        <option value="linear-gradient(to right, #2193b0, #6dd5ed)">Ocean</option>
        <option value="linear-gradient(to right, #0f2027, #203a43, #2c5364)">Galaxy</option>
        <option value="linear-gradient(to right, #ff9a9e, #fad0c4)">Blossom</option>
      </select>
    </div>
    <div style="margin-top:12px">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Task Dialog -->
  <div id="taskDialog" class="hidden" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(6,8,12,0.95); padding:16px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:320px; z-index:999;">
    <h3 id="taskDialogTitle">Add Task</h3>
    <input type="text" id="taskText" placeholder="Task description">
    <label style="font-size:13px; opacity:0.9; display:block; text-align:left; margin-left:4px;">Color</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="taskColor" value="#ffd166">
      <div id="taskColorPreview" style="width:34px; height:34px; border-radius:6px; border:2px solid rgba(255,255,255,0.12);"></div>
    </div>
    <div id="dialogPaletteRow" class="palette-row" style="margin-top:8px;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button onclick="closeTaskDialog()">Cancel</button>
      <button onclick="saveTaskFromDialog()" class="list-button">Save</button>
    </div>
  </div>

  <!-- Pet Settings Dialog -->
  <div id="petDialog" class="hidden" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(6,8,12,0.95); padding:16px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:320px; z-index:999;">
    <h3>üêæ Pet Settings</h3>
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Pet Name:</label>
    <input type="text" id="petNameInput" placeholder="Name your pet" style="width:100%;">
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Choose Pet:</label>
    <div id="petChoices" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"></div>
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Unlocked Accessories:</label>
    <div id="accessoryChoices" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button onclick="closePetDialog()">Cancel</button>
      <button onclick="savePetSettings()" class="list-button">Save</button>
    </div>
  </div>

  <!-- Task Color Picker Modal -->
  <div id="taskColorOverlay" class="modal-overlay hidden" onclick="closeTaskColorPicker()"></div>
  <div id="taskColorModal" class="hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(6,8,12,0.95); padding:20px; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:300px; z-index:1000;">
    <h3 style="margin-top:0;">üé® Change Task Color</h3>
    <div id="taskColorName" style="font-size:14px; opacity:0.8; margin-bottom:12px;"></div>
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <input type="color" id="taskColorInput" value="#ffd166" style="width:60px; height:40px; padding:0; border:none; cursor:pointer;">
      <div id="taskColorPreviewBox" style="flex:1; height:40px; border-radius:8px; background:#ffd166;"></div>
    </div>
    <div style="font-size:12px; margin-bottom:8px;">Quick colors from palette:</div>
    <div id="taskColorPalette" class="palette-row" style="margin-bottom:16px;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button onclick="closeTaskColorPicker()">Cancel</button>
      <button onclick="saveTaskColor()" class="list-button">Save</button>
    </div>
  </div>

<script>
/* ========== SUPABASE CONFIG ========== */
const SUPABASE_URL = 'https://caafadtwoeayphbtkxmq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhYWZhZHR3b2VheXBoYnRreG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjQwMDEsImV4cCI6MjA4MzA0MDAwMX0.Uqn_SLdlKA1Scp6yTqP1yZd1G6KpKD6CTL8hukzUzHk';

const supabaseClient = {
  async fetch(endpoint, options = {}) {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
      ...options,
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': options.prefer || 'return=representation',
        ...options.headers
      }
    });
    if (!response.ok) {
      const error = await response.text();
      throw new Error(error);
    }
    return response.json();
  }
};

async function saveToCloud(username, data) {
  try {
    const existing = await supabaseClient.fetch(`users?username=eq.${encodeURIComponent(username)}&select=id`);
    
    if (existing.length > 0) {
      // Update existing user
      await supabaseClient.fetch(`users?username=eq.${encodeURIComponent(username)}`, {
        method: 'PATCH',
        body: JSON.stringify({ data: data, updated_at: new Date().toISOString() })
      });
      console.log('‚úÖ Updated in cloud');
    } else {
      // User doesn't exist in cloud yet - create them
      await supabaseClient.fetch('users', {
        method: 'POST',
        body: JSON.stringify({
          username: username,
          password: data.password || '',
          data: data
        })
      });
      console.log('‚úÖ Created in cloud');
    }
  } catch (err) {
    console.error('Cloud save failed:', err);
  }
}

async function loadFromCloud(username) {
  try {
    const result = await supabaseClient.fetch(`users?username=eq.${encodeURIComponent(username)}&select=data`);
    if (result.length > 0) {
      console.log('‚úÖ Loaded from cloud');
      return result[0].data;
    }
  } catch (err) {
    console.error('Cloud load failed:', err);
  }
  return null;
}

async function cloudLogin(username, password) {
  try {
    const result = await supabaseClient.fetch(
      `users?username=eq.${encodeURIComponent(username)}&select=*`
    );
    if (result.length > 0) {
      // Check password from the data column or the password column
      const user = result[0];
      const storedPassword = user.data?.password || user.password;
      if (storedPassword === password) {
        console.log('‚úÖ Cloud login successful');
        return user;
      }
    }
  } catch (err) {
    console.error('Cloud login failed:', err);
  }
  return null;
}

async function cloudSignup(username, password, userData) {
  try {
    const existing = await supabaseClient.fetch(`users?username=eq.${encodeURIComponent(username)}&select=id`);
    if (existing.length > 0) {
      return { error: 'Username already exists' };
    }
    
    const result = await supabaseClient.fetch('users', {
      method: 'POST',
      body: JSON.stringify({
        username,
        password,
        data: userData
      })
    });
    return result[0];
  } catch (err) {
    console.error('Cloud signup failed:', err);
    return { error: err.message };
  }
}

/* ========== UTILITIES ========== */
function $(id){return document.getElementById(id);}
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function getUsers(){ return JSON.parse(localStorage.getItem('users') || '{}'); }
function saveUsers(u){ 
  localStorage.setItem('users', JSON.stringify(u)); 
  // Sync to cloud if logged in
  if (currentUser && u[currentUser]) {
    saveToCloud(currentUser, u[currentUser]);
  }
}

let currentUser = localStorage.getItem('currentUser') || null;
let currentUserName = null;
let allLists = [];
let activeListIndex = 0;
let pickedBackground = 'default';

// Task timer tracking
let activeTaskTimer = null; // { listIndex, taskIndex, startTime, intervalId }

// Focus timer
let focusTimerInterval = null;
let focusTimerSeconds = 25 * 60;
let focusTimerTotal = 25 * 60;
let focusTimerRunning = false;

// Pet decay interval
let petDecayInterval = null;

// Today's date for tracking daily tasks
function getTodayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* Hide panels on load */
$('topPanels').classList.add('hidden');

/* ========== QUOTES ========== */
const quotes = [
  { text: "Only put off until tomorrow what you are willing to die having left undone.", author: "Pablo Picasso" },
  { text: "Your future is created by what you do today, not tomorrow.", author: "Robert Kiyosaki" },
  { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
  { text: "You may delay, but time will not.", author: "Benjamin Franklin" },
  { text: "Procrastination is the thief of time.", author: "Edward Young" },
  { text: "A year from now you may wish you had started today.", author: "Karen Lamb" },
  { text: "Do the hard jobs first. The easy jobs will take care of themselves.", author: "Dale Carnegie" },
  { text: "Amateurs sit and wait for inspiration, the rest of us just get up and go to work.", author: "Stephen King" },
  { text: "Don't wait. The time will never be just right.", author: "Napoleon Hill" },
  { text: "It always seems impossible until it's done.", author: "Nelson Mandela" },
  { text: "Well done is better than well said.", author: "Benjamin Franklin" },
  { text: "The only difference between success and failure is the ability to take action.", author: "Alexander Graham Bell" },
  { text: "If you put off everything till you're sure of it, you'll never get anything done.", author: "Norman Vincent Peale" },
  { text: "Procrastination is opportunity's assassin.", author: "Victor Kiam" },
  { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
  { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
  { text: "Small deeds done are better than great deeds planned.", author: "Peter Marshall" },
  { text: "You don't have to see the whole staircase, just take the first step.", author: "Martin Luther King Jr." },
  { text: "Don't let perfectionism become an excuse for never getting started.", author: "Marilu Henner" },
  { text: "Yesterday you said tomorrow. Just do it.", author: "Nike" },
  { text: "To think too long about doing a thing often becomes its undoing.", author: "Eva Young" },
  { text: "The best way to get something done is to begin.", author: "Unknown" },
  { text: "Stop talking. Start walking.", author: "L.M. Heroux" },
  { text: "The greatest amount of wasted time is the time not getting started.", author: "Dawson Trotman" },
  { text: "A year from now, you will wish you had started today.", author: "Unknown" },
  { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
  { text: "Motivation is what gets you started. Habit is what keeps you going.", author: "Jim Rohn" },
  { text: "Dreams don't work unless you do.", author: "John C. Maxwell" },
  { text: "One of these days is none of these days.", author: "H.G. Bohn" },
  { text: "The future depends on what you do today.", author: "Mahatma Gandhi" },
  { text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller" },
  { text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" },
  { text: "Time is an equal opportunity employer.", author: "Denis Waitley" },
  { text: "Success is the sum of small efforts repeated day in and day out.", author: "Robert Collier" },
  { text: "Do something today that your future self will thank you for.", author: "Unknown" },
  { text: "It's not always that we need to do more but rather that we need to focus on less.", author: "Nathan W. Morris" },
  { text: "Your mind is for having ideas, not holding them.", author: "David Allen" },
  { text: "Begin while others are procrastinating. Work while others are wishing.", author: "William Arthur Ward" },
  { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
  { text: "Don't let yesterday take up too much of today.", author: "Will Rogers" },
  { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
  { text: "Great acts are made up of small deeds.", author: "Lao Tzu" },
  { text: "By the yard it's hard; but inch by inch, anything's a cinch.", author: "Brian Tracy" },
  { text: "If not now, when?", author: "Hillel the Elder" },
  { text: "The sooner I fall behind, the more time I have to catch up.", author: "Unknown" },
  { text: "Things may come to those who wait, but only the things left by those who hustle.", author: "Abraham Lincoln" },
  { text: "Don't ruin a good today by thinking about a bad yesterday.", author: "Unknown" },
  { text: "Take time to deliberate; but when the time for action arrives, stop thinking and go in.", author: "Napoleon Bonaparte" },
  { text: "A task begun is half done.", author: "Zeno of Citium" },
  { text: "Even if you are on the right track, you'll get run over if you just sit there.", author: "Will Rogers" },
  { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
  { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
  { text: "You can't build a reputation on what you are going to do.", author: "Henry Ford" },
  { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
  { text: "The future starts today, not tomorrow.", author: "Pope John Paul II" },
  { text: "An ounce of action is worth a ton of theory.", author: "Ralph Waldo Emerson" },
  { text: "A good plan violently executed now is better than a perfect plan executed next week.", author: "George S. Patton" },
  { text: "Do not wait to strike till the iron is hot; but make it hot by striking.", author: "William Butler Yeats" },
  { text: "In a moment of decision, the best thing you can do is the right thing. The worst thing you can do is nothing.", author: "Theodore Roosevelt" },
  { text: "If you have time to whine then you have time to find a solution.", author: "Dee Dee Artner" },
  { text: "Take action! An inch of movement will bring you closer to your goals than a mile of intention.", author: "Steve Maraboli" },
  { text: "If you want to make an easy job seem mighty hard, just keep putting off doing it.", author: "Olin Miller" },
  { text: "Do it now. Sometimes 'later' becomes 'never'.", author: "Unknown" },
  { text: "Waiting is a trap. There will always be reasons to wait.", author: "Anonymous" },
  { text: "Someday is not a day of the week.", author: "Janet Dailey" },
  { text: "The only impossible journey is the one you never begin.", author: "Tony Robbins" },
  { text: "Don't wait for your feelings to change to take the action. Take the action and your feelings will change.", author: "Barbara Baron" },
  { text: "Your action expresses your priorities.", author: "Mahatma Gandhi" },
  { text: "He who hesitates is lost.", author: "Proverb" },
  { text: "The best way to predict the future is to create it.", author: "Peter Drucker" },
  { text: "It's not about ideas. It's about making ideas happen.", author: "Scott Belsky" },
  { text: "Stop wishing, start doing.", author: "Unknown" },
  { text: "We generate fears while we sit. We overcome them by action.", author: "Dr. Henry Link" },
  { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
  { text: "To achieve great things, two things are needed: a plan and not quite enough time.", author: "Leonard Bernstein" },
  { text: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" },
  { text: "Action cures fear.", author: "David J. Schwartz" },
  { text: "I attribute my success to this: I never gave or took any excuse.", author: "Florence Nightingale" },
  { text: "How soon 'not now' becomes 'never'.", author: "Martin Luther" },
  { text: "If something is important enough, even if the odds are against you, you should still do it.", author: "Elon Musk" },
  { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
  { text: "Do the difficult things while they are easy and do the great things while they are small.", author: "Lao Tzu" },
  { text: "Act or accept.", author: "Unknown" },
  { text: "Even if you fall on your face, you're still moving forward.", author: "Victor Kiam" },
  { text: "Inspiration usually comes during work, rather than before it.", author: "Madeleine L'Engle" },
  { text: "The beginning is the most important part of the work.", author: "Plato" },
  { text: "Don't fear failure. Fear being in the exact same place next year as you are today.", author: "Unknown" },
  { text: "Success seems to be connected with action. Successful people keep moving.", author: "Conrad Hilton" },
  { text: "All our dreams can come true if we have the courage to pursue them.", author: "Walt Disney" },
  { text: "Ideas are worthless without execution.", author: "Gary Vaynerchuk" },
  { text: "What you do today can improve all your tomorrows.", author: "Ralph Marston" },
  { text: "Don't let the fear of losing be greater than the excitement of winning.", author: "Robert Kiyosaki" },
  { text: "Without hustle, talent will only carry you so far.", author: "Gary Vaynerchuk" },
  { text: "Screw it, let's do it.", author: "Richard Branson" },
  { text: "If you can't fly, then run. If you can't run, then walk. If you can't walk, then crawl, but by all means, keep moving.", author: "Martin Luther King Jr." },
  { text: "The most effective way to do it, is to do it.", author: "Amelia Earhart" },
  { text: "Less talk, more action.", author: "Unknown" },
  { text: "Dream big, start small, but most of all, start.", author: "Simon Sinek" },
  { text: "There is no substitute for hard work.", author: "Thomas Edison" },
  { text: "If opportunity doesn't knock, build a door.", author: "Milton Berle" },
  { text: "Ordinary people think merely of spending time; great people think of using it.", author: "Arthur Schopenhauer" },
  { text: "Being relaxed, at peace with yourself, confident, emotionally neutral, loose, and free-floating ‚Äì these are the keys to successful performance in almost everything.", author: "Dr. Wayne W. Dyer" },
  { text: "It is not the strongest of the species that survive, nor the most intelligent, but the one most responsive to change.", author: "Charles Darwin" },
  { text: "Success is almost totally dependent upon drive and persistence. The extra energy required to make another effort or try another approach is the secret of winning.", author: "Denis Waitley" },
  { text: "Nothing can stop the man with the right mental attitude from achieving his goal; nothing on earth can help the man with the wrong mental attitude.", author: "Thomas Jefferson" },
  { text: "What we think determines what happens to us, so if we want to change our lives, we need to stretch our minds.", author: "Wayne Dyer" },
  { text: "The world can only be grasped by action, not by contemplation. The hand is more important than the eye. The hand is the cutting edge of the mind.", author: "J. Bronowski" },
  { text: "It does not take much strength to do things, but it requires a great deal of strength to decide what to do.", author: "Elbert Hubbard" },
  { text: "The secret of getting ahead is getting started. The secret of getting started is breaking your complex overwhelming tasks into small, manageable tasks, and then starting on the first one.", author: "Mark Twain" },
  { text: "You've got to think about the big things while you're doing small things, so that all the small things go in the right direction.", author: "Alvin Toffler" },
  { text: "Every now and then go away, have a little relaxation, for when you come back to your work your judgment will be surer.", author: "Leonardo da Vinci" },
  { text: "Start by doing what's necessary, then what's possible, and suddenly you are doing the impossible.", author: "Saint Francis of Assisi" },
  { text: "I have always thought that one man of tolerable abilities may work great changes, and accomplish great affairs among mankind.", author: "Benjamin Franklin" },
  { text: "Enter every activity without giving mental recognition to the possibility of defeat. Concentrate on your strengths, instead of your weaknesses.", author: "Paul J. Meyer" },
  { text: "In the world of business, the people who are most successful are those who are doing what they love.", author: "Warren Buffett" },
  { text: "Success is often achieved by those who don't know that failure is inevitable.", author: "Coco Chanel" },
  { text: "My goal is no longer to get more done, but rather to have less to do.", author: "Francine Jay" },
  { text: "If you don't like how things are, change it! You're not a tree.", author: "Jim Rohn" },
  { text: "We must accept finite disappointment, but never lose infinite hope.", author: "Martin Luther King, Jr." },
  { text: "Surround yourself only with people who are going to take you higher.", author: "Oprah Winfrey" },
  { text: "Inspiration exists, but it has to find you working.", author: "Pablo Picasso" },
  { text: "How dare you settle for less when the world has made it so easy for you to be remarkable?", author: "Seth Godin" },
  { text: "One, remember to look up at the stars and not down at your feet. Two, never give up work. Work gives you meaning and purpose, and life is empty without it.", author: "Stephen Hawking" },
  { text: "When one door closes, another door opens; but we so often look so long and so regretfully upon the closed door that we do not see the ones which open for us.", author: "Alexander Graham Bell" },
  { text: "Consider everything an experiment.", author: "Corita Kent" },
  { text: "Conformity is the jailer of freedom and the enemy of growth.", author: "John F. Kennedy" },
  { text: "Keep your eyes on the stars and your feet on the ground.", author: "Theodore Roosevelt" },
  { text: "The potential of controlling and living a successful life according to your terms depends on how you think. Your perception is your world.", author: "Dee Dee Artner" },
  { text: "When obstacles arise, you change your direction to reach your goal; you do not change your decision to get there.", author: "Zig Ziglar" },
  { text: "Efficiency is doing better what is already being done.", author: "Peter Drucker" },
  { text: "There's a way to do it better. Find it!", author: "Thomas Edison" },
  { text: "If the ladder is not leaning against the right wall, every step we take just gets us to the wrong place faster.", author: "Stephen Covey" },
  { text: "Time is the scarcest resource, and unless it is managed, nothing else can be managed.", author: "Peter Drucker" },
  { text: "There is nothing so useless as doing efficiently that which should not be done at all.", author: "Peter Drucker" },
  { text: "Progress isn't made by early risers. It's made by lazy men trying to find easier ways to do something.", author: "Robert A. Heinlein" },
  { text: "You cannot increase the quality or quantity of your achievement or performance except to the degree in which you increase your ability to use your time effectively.", author: "Brian Tracy" },
  { text: "It's not enough to be busy; so are the ants. The question is, what are we busy about?", author: "Henry David Thoreau" },
  { text: "Efficiency is intelligent laziness.", author: "David Dunham" },
  { text: "If I had six hours to chop down a tree, I'd spend the first four hours sharpening the axe.", author: "Abraham Lincoln" },
  { text: "A sense of the value of time ‚Äì that is, of the best way to divide one's time into one's various activities ‚Äì is an essential preliminary to efficient work.", author: "Arnold Bennett" },
  { text: "Obviously, the highest type of efficiency is that which can utilize existing material to the best advantage.", author: "Jawaharlal Nehru" },
  { text: "Besides the noble art of getting things done, there is the noble art of leaving things undone. The wisdom of life consists in the elimination of non-essentials.", author: "Lin Yutang" },
  { text: "By concentrating our efforts upon a few major goals, our efficiency soars, our projects are completed, we are going somewhere.", author: "Michael Korda" },
  { text: "The combination of hard work and smart work is efficient work.", author: "Robert Half" },
  { text: "Efficiency is doing things ‚Äì not wishing you could do them, dreaming about them, or wondering if you can do them.", author: "Frank Crane" },
  { text: "Don't lower your expectations to meet your performance. Raise your level of performance to meet your expectations.", author: "Ralph Marston" },
  { text: "Quality means doing it right when no one is looking.", author: "Henry Ford" },
  { text: "Be a yardstick of quality. Some people aren't used to an environment where excellence is expected.", author: "Steve Jobs" },
  { text: "The starting point of all achievement is desire.", author: "Napoleon Hill" },
  { text: "Without changing our patterns of thought, we will not be able to solve the problems that we created with our current patterns of thought.", author: "Albert Einstein" },
  { text: "Quality is not an act; it is a habit.", author: "Aristotle" },
  { text: "Quality is never an accident. It is always the result of intelligent effort.", author: "John Ruskin" },
  { text: "Quality is more important than quantity. One home run is much better than two doubles.", author: "Steve Jobs" },
  { text: "Focus on being productive instead of busy.", author: "Tim Ferriss" },
  { text: "Simplicity boils down to two steps: Identify the essential. Eliminate the rest.", author: "Leo Babauta" },
  { text: "Your work is going to fill a large part of your life, and the only way to be truly satisfied is to do what you believe is great work.", author: "Steve Jobs" },
  { text: "It's not that I'm so smart; it's just that I stay with problems longer.", author: "Albert Einstein" },
  { text: "The only thing to do with good advice is to pass it on. It is never of any use to oneself.", author: "Oscar Wilde" },
  { text: "Why do anything unless it is going to be great?", author: "Peter Block" },
  { text: "Simple, clear purpose and principles give rise to complex and intelligent behavior.", author: "Dee Hock" },
  { text: "Quality needs to be constantly improved, but it is just as necessary to make sure that quality never deteriorates.", author: "Shigeru Mizuno" },
  { text: "Productivity is being able to do things that you were never able to do before.", author: "Franz Kafka" },
  { text: "If there are nine rabbits on the ground, if you want to catch one, just focus on one.", author: "Jack Ma" },
  { text: "Sometimes, things may not go your way, but the effort should be there every single night.", author: "Michael Jordan" },
  { text: "If you spend too much time thinking about a thing, you'll never get it done.", author: "Bruce Lee" },
  { text: "He who is not courageous enough to take risks will accomplish nothing in life.", author: "Muhammad Ali" },
  { text: "Setting goals is the first step in turning the invisible into the visible.", author: "Tony Robbins" },
  { text: "Productivity is never an accident. It is always the result of a commitment to excellence, intelligent planning, and focused effort.", author: "Paul J. Meyer" },
  { text: "Don't say, 'If I could, I would.' Say, 'If I can, I will.'", author: "Jim Rohn" },
  { text: "Your 'I CAN' is more important than your IQ.", author: "Robin Sharma" },
  { text: "The best way out is always through.", author: "Robert Frost" },
  { text: "There are risks and costs to action. But they are far less than the long-range risks of comfortable inaction.", author: "John F. Kennedy" },
  { text: "He can who thinks he can, and he can't who thinks he can't. This is an inexorable, indisputable law.", author: "Pablo Picasso" }
];

function showNewQuote(){
  const q = quotes[Math.floor(Math.random() * quotes.length)];
  $('quoteText').textContent = `"${q.text}"`;
  $('quoteAuthor').textContent = `‚Äî ${q.author}`;
}

/* ========== VIRTUAL PET ========== */
const petTypes = ['üê±', 'üê∂', 'üê∞', 'üêª', 'ü¶ä', 'üêº', 'üê∏', 'üêß', 'ü¶Ñ', 'üê≤'];
const accessories = [
  { emoji: '', name: 'None', unlockLevel: 0 },
  { emoji: 'üé©', name: 'Top Hat', unlockLevel: 2 },
  { emoji: 'üëí', name: 'Sun Hat', unlockLevel: 3 },
  { emoji: 'üéÄ', name: 'Bow', unlockLevel: 4 },
  { emoji: 'üëë', name: 'Crown', unlockLevel: 5 },
  { emoji: 'üï∂Ô∏è', name: 'Sunglasses', unlockLevel: 6 },
  { emoji: 'üß¢', name: 'Cap', unlockLevel: 7 },
  { emoji: 'üå∏', name: 'Flower', unlockLevel: 8 },
  { emoji: '‚≠ê', name: 'Star', unlockLevel: 10 }
];

/* ========== TASK COMPLETION MESSAGES ========== */
const completionMessages = [
  "That task did not stand a CHANCE! üí™",
  "PRODUCTIVITY!!!!!",
  "You're on FIRE! üî•",
  "Absolutely CRUSHED it!",
  "Task? What task? DEMOLISHED!",
  "You're a productivity MACHINE!",
  "Another one bites the dust! üéµ",
  "BOOM! Task eliminated!",
  "Was that even a challenge?",
  "You make it look EASY!",
  "Unstoppable! üöÄ",
  "Task destroyed in record time!",
  "That's how it's DONE!",
  "You're killing it today!",
  "Legendary productivity move!",
  "Task completed like a BOSS!",
  "Nothing can stop you!",
  "You're in the ZONE!",
  "Efficiency level: MAXIMUM!",
  "That task never saw it coming!",
  "WINNER! üèÜ",
  "Productivity king/queen!",
  "Task annihilated!",
  "You're built different!",
  "Absolutely SMASHED it!",
  "Keep this energy! ‚ö°",
  "Task? More like no task!",
  "You're too good at this!",
  "GET AFTER IT!",
  "Momentum is BUILDING!",
  "One down, glory to go!",
  "Excellence achieved!",
  "That was smooth!",
  "Chef's kiss on that one! üë®‚Äçüç≥",
  "Pure domination!",
  "Task erased from existence!",
  "You're a force of nature!",
  "FLAWLESS execution!",
  "Making progress look GOOD!",
  "You're on a roll! üé≤",
  "Task obliterated!",
  "Simply magnificent!",
  "You're crushing your goals!",
  "That was surgical precision!",
  "Task vaporized! üí®",
  "Look at you GO!",
  "Productivity unlocked!",
  "You're in beast mode!",
  "Another victory! üèÖ",
  "Task sent to the shadow realm!",
  "Impressive work!",
  "You're making waves! üåä",
  "Nailed it! üî®",
  "Task conquered!",
  "You're a productivity ninja!",
  "Smooth operator!",
  "That's the spirit!",
  "Task eliminated with style!",
  "You're winning at life!",
  "Absolutely stellar!",
  "Keep stacking those wins!",
  "Task? Never heard of her!",
  "You're an inspiration!",
  "Maximum effort achieved!",
  "That was beautiful!",
  "Productivity overload!",
  "You're unstoppable today!",
  "Task deleted successfully! üóëÔ∏è",
  "Pure excellence!",
  "You're doing amazing!",
  "That's what I'm talking about!",
  "Task wrecked!",
  "You're leveling up!",
  "Absolutely incredible!",
  "Task? Handled!",
  "You're a productivity legend!",
  "That was satisfying!",
  "Keep the momentum going!",
  "Task destroyed with ease!",
  "You're crushing it!",
  "Phenomenal work!",
  "Task? Child's play!",
  "You're on another level!",
  "That's how winners do it!",
  "Task terminated!",
  "You're making it happen!",
  "Superstar performance! ‚≠ê",
  "Task sent packing!",
  "You're a productivity god!",
  "That was epic!",
  "Keep being awesome!",
  "Task? Bye bye! üëã",
  "You're dominating!",
  "Incredible focus!",
  "Task pulverized!",
  "You're the real MVP!",
  "That's a W!",
  "Task officially DONE!",
  "You're built for success!",
  "Masterfully executed!"
];

function showCompletionPopup(){
  const popup = $('taskCompletionPopup');
  const message = completionMessages[Math.floor(Math.random() * completionMessages.length)];
  $('completionMessage').textContent = message;
  
  popup.classList.remove('hidden', 'popup-exit');
  
  setTimeout(() => {
    popup.classList.add('popup-exit');
    setTimeout(() => {
      popup.classList.add('hidden');
      popup.classList.remove('popup-exit');
    }, 200);
  }, 1500);
}

function getDifficultyEmoji(difficulty){
  switch(difficulty){
    case 'insane': return 'ü§Ø';
    case 'hard': return 'üò§';
    case 'medium': return 'üòê';
    case 'easy': return 'üôÇ';
    case 'really-easy': return 'üòå';
    default: return 'üòê';
  }
}

function showConfetti(count){
  const colors = ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#ff6bcb', '#9b59b6', '#f39c12'];
  const container = document.body;
  
  for (let i = 0; i < count; i++){
    const confetti = document.createElement('div');
    confetti.style.cssText = `
      position: fixed;
      width: ${Math.random() * 10 + 5}px;
      height: ${Math.random() * 10 + 5}px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      left: ${Math.random() * 100}vw;
      top: -20px;
      border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
      pointer-events: none;
      z-index: 9999;
      opacity: 1;
    `;
    container.appendChild(confetti);
    
    const fallDuration = Math.random() * 2 + 2;
    const swayAmount = Math.random() * 100 - 50;
    const rotation = Math.random() * 720;
    
    confetti.animate([
      { transform: 'translateY(0) translateX(0) rotate(0deg)', opacity: 1 },
      { transform: `translateY(100vh) translateX(${swayAmount}px) rotate(${rotation}deg)`, opacity: 0 }
    ], {
      duration: fallDuration * 1000,
      easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
    }).onfinish = () => confetti.remove();
  }
}

function getPetData(){
  if (!currentUser) return null;
  const users = getUsers();
  if (!users[currentUser]) return null;
  return users[currentUser].pet || { 
    name: 'Pixel', 
    emoji: 'üê±', 
    happiness: 50, 
    xp: 0, 
    level: 1, 
    accessory: '', 
    lastActive: Date.now(),
    tasksToday: 0,
    lastTaskDate: ''
  };
}

function savePetData(pet){
  if (!currentUser) return;
  const users = getUsers();
  if (!users[currentUser]) return;
  users[currentUser].pet = pet;
  saveUsers(users);
}

function getUnlockedPetCount(xp){
  // 1 pet unlocked at start, then 1 more every 100 XP (max 10 pets)
  return Math.min(10, 1 + Math.floor(xp / 100));
}

function getTasksCompletedToday(){
  const pet = getPetData();
  if (!pet) return 0;
  const today = getTodayStr();
  if (pet.lastTaskDate !== today) {
    return 0;
  }
  return pet.tasksToday || 0;
}

function updatePetHappinessFromTasks(){
  const pet = getPetData();
  if (!pet) return;
  
  const today = getTodayStr();
  
  // Reset tasks count if it's a new day
  if (pet.lastTaskDate !== today) {
    pet.tasksToday = 0;
    pet.lastTaskDate = today;
    pet.happiness = 0; // Start sad at beginning of day
  }
  
  // Happiness based on tasks: 0 tasks = 0%, 5+ tasks = 100%
  const tasksToday = pet.tasksToday || 0;
  pet.happiness = Math.min(100, tasksToday * 20); // 20% per task, max 100%
  
  savePetData(pet);
  renderPet();
}

function renderPet(){
  const pet = getPetData();
  if (!pet) return;
  
  const today = getTodayStr();
  const tasksToday = (pet.lastTaskDate === today) ? (pet.tasksToday || 0) : 0;
  const unlockedCount = getUnlockedPetCount(pet.xp);
  
  $('petEmoji').textContent = pet.emoji || 'üê±';
  $('petAccessory').textContent = pet.accessory || '';
  $('petName').textContent = pet.name || 'Pixel';
  $('petLevel').textContent = `Level ${pet.level} ‚Ä¢ ${pet.xp} XP`;
  $('happinessFill').style.width = `${pet.happiness}%`;
  $('tasksToday').textContent = `Tasks today: ${tasksToday}/5`;
  $('unlockedPets').textContent = `üîì ${unlockedCount}/10 pets unlocked`;
  
  const petDisplay = $('petDisplay');
  petDisplay.classList.remove('pet-sad', 'pet-bounce');
  
  if (pet.happiness >= 80) {
    $('petMood').textContent = 'üòä So happy!';
  } else if (pet.happiness >= 60) {
    $('petMood').textContent = 'üôÇ Feeling good!';
  } else if (pet.happiness >= 40) {
    $('petMood').textContent = 'üòê Okay...';
  } else if (pet.happiness >= 20) {
    $('petMood').textContent = 'üò¢ Getting sad...';
    petDisplay.classList.add('pet-sad');
  } else {
    $('petMood').textContent = 'üò≠ Please do tasks!';
    petDisplay.classList.add('pet-sad');
  }
}

function petGainXP(amount){
  const pet = getPetData();
  if (!pet) return;
  
  const oldUnlocked = getUnlockedPetCount(pet.xp);
  pet.xp += amount;
  const newUnlocked = getUnlockedPetCount(pet.xp);
  
  // Check if new pet unlocked
  if (newUnlocked > oldUnlocked && newUnlocked <= 10) {
    const newPetEmoji = petTypes[newUnlocked - 1];
    alert(`üéâ New pet unlocked: ${newPetEmoji}! You now have ${newUnlocked}/10 pets!`);
  }
  
  // Level up check (100 XP per level)
  const newLevel = Math.floor(pet.xp / 100) + 1;
  if (newLevel > pet.level) {
    pet.level = newLevel;
  }
  
  savePetData(pet);
  renderPet();
  
  // Bounce animation
  const petDisplay = $('petDisplay');
  petDisplay.classList.remove('pet-bounce');
  void petDisplay.offsetWidth;
  petDisplay.classList.add('pet-bounce');
}

function incrementTasksToday(){
  const pet = getPetData();
  if (!pet) return;
  
  const today = getTodayStr();
  
  // Reset if new day
  if (pet.lastTaskDate !== today) {
    pet.tasksToday = 0;
    pet.lastTaskDate = today;
  }
  
  pet.tasksToday = (pet.tasksToday || 0) + 1;
  pet.happiness = Math.min(100, pet.tasksToday * 20);
  pet.lastActive = Date.now();
  
  savePetData(pet);
  renderPet();
  petGainXP(10);
}

function petDecay(){
  const pet = getPetData();
  if (!pet) return;
  
  // Only decay if no tasks have been started recently
  const timeSinceActive = Date.now() - (pet.lastActive || Date.now());
  const minutesSinceActive = timeSinceActive / (1000 * 60);
  
  // Decay 5% happiness every 10 minutes of inactivity
  if (minutesSinceActive > 10) {
    pet.happiness = Math.max(0, pet.happiness - 5);
    savePetData(pet);
    renderPet();
  }
}

function startPetDecay(){
  if (petDecayInterval) clearInterval(petDecayInterval);
  // Check every 5 minutes
  petDecayInterval = setInterval(petDecay, 5 * 60 * 1000);
}

function openPetSettings(){
  const pet = getPetData();
  if (!pet) return;
  
  $('petNameInput').value = pet.name || 'Pixel';
  
  const unlockedCount = getUnlockedPetCount(pet.xp);
  
  const petChoicesDiv = $('petChoices');
  petChoicesDiv.innerHTML = '';
  petTypes.forEach((emoji, index) => {
    const isUnlocked = index < unlockedCount;
    const xpNeeded = index * 100;
    
    const btn = document.createElement('button');
    btn.textContent = isUnlocked ? emoji : 'üîí';
    btn.title = isUnlocked ? emoji : `Unlock at ${xpNeeded} XP`;
    btn.style.fontSize = '24px';
    btn.style.padding = '8px';
    btn.style.background = pet.emoji === emoji ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = isUnlocked ? 'pointer' : 'not-allowed';
    btn.style.opacity = isUnlocked ? '1' : '0.4';
    btn.disabled = !isUnlocked;
    
    btn.onclick = () => {
      if (!isUnlocked) return;
      petChoicesDiv.querySelectorAll('button').forEach(b => {
        b.style.background = 'rgba(255,255,255,0.1)';
        delete b.dataset.selected;
      });
      btn.style.background = 'rgba(255,255,255,0.3)';
      btn.dataset.selected = 'true';
      btn.dataset.emoji = emoji;
    };
    if (pet.emoji === emoji) {
      btn.dataset.selected = 'true';
      btn.dataset.emoji = emoji;
    }
    petChoicesDiv.appendChild(btn);
  });
  
  const accDiv = $('accessoryChoices');
  accDiv.innerHTML = '';
  accessories.forEach(acc => {
    const btn = document.createElement('button');
    btn.textContent = acc.emoji || '‚ùå';
    btn.title = acc.name + (acc.unlockLevel > pet.level ? ` (Unlock at Lvl ${acc.unlockLevel})` : '');
    btn.style.fontSize = '20px';
    btn.style.padding = '6px';
    btn.style.background = pet.accessory === acc.emoji ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = acc.unlockLevel <= pet.level ? 'pointer' : 'not-allowed';
    btn.style.opacity = acc.unlockLevel <= pet.level ? '1' : '0.4';
    btn.disabled = acc.unlockLevel > pet.level;
    btn.onclick = () => {
      if (acc.unlockLevel > pet.level) return;
      accDiv.querySelectorAll('button').forEach(b => {
        b.style.background = 'rgba(255,255,255,0.1)';
        delete b.dataset.selected;
      });
      btn.style.background = 'rgba(255,255,255,0.3)';
      btn.dataset.selected = 'true';
      btn.dataset.emoji = acc.emoji;
    };
    if (pet.accessory === acc.emoji) {
      btn.dataset.selected = 'true';
      btn.dataset.emoji = acc.emoji;
    }
    accDiv.appendChild(btn);
  });
  
  $('petDialog').classList.remove('hidden');
}

function closePetDialog(){ $('petDialog').classList.add('hidden'); }

function savePetSettings(){
  const pet = getPetData();
  if (!pet) return;
  
  pet.name = $('petNameInput').value.trim() || 'Pixel';
  
  const selectedPet = $('petChoices').querySelector('[data-selected="true"]');
  if (selectedPet && selectedPet.dataset.emoji) {
    pet.emoji = selectedPet.dataset.emoji;
  }
  
  const selectedAcc = $('accessoryChoices').querySelector('[data-selected="true"]');
  if (selectedAcc) pet.accessory = selectedAcc.dataset.emoji || '';
  
  savePetData(pet);
  renderPet();
  closePetDialog();
}

/* ========== FOCUS TIMER ========== */
function updateTimerDisplay(){
  const mins = Math.floor(focusTimerSeconds / 60);
  const secs = focusTimerSeconds % 60;
  $('timerDisplay').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  const progress = (focusTimerSeconds / focusTimerTotal) * 100;
  $('timerProgressFill').style.width = `${progress}%`;
}

function startTimer(){
  if (focusTimerRunning) return;
  
  if (focusTimerSeconds <= 0) {
    focusTimerTotal = parseInt($('timerMinutes').value) * 60 || 25 * 60;
    focusTimerSeconds = focusTimerTotal;
  }
  
  focusTimerRunning = true;
  focusTimerInterval = setInterval(() => {
    focusTimerSeconds--;
    updateTimerDisplay();
    
    if (focusTimerSeconds <= 0) {
      clearInterval(focusTimerInterval);
      focusTimerRunning = false;
      playChime();
      alert('‚è∞ Timer complete! Great focus session!');
      petGainXP(20);
    }
  }, 1000);
}

function pauseTimer(){
  if (focusTimerInterval) {
    clearInterval(focusTimerInterval);
    focusTimerRunning = false;
  }
}

function resetTimer(){
  pauseTimer();
  focusTimerTotal = parseInt($('timerMinutes').value) * 60 || 25 * 60;
  focusTimerSeconds = focusTimerTotal;
  updateTimerDisplay();
}

function playChime(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const frequencies = [523.25, 659.25, 783.99, 1046.50];
    
    frequencies.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      
      const startTime = ctx.currentTime + (i * 0.15);
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.8);
      
      osc.start(startTime);
      osc.stop(startTime + 0.8);
    });
  } catch(e) {}
}

/* ========== TASK TIME TRACKING ========== */
function formatTime(seconds){
  const mins = Math.floor(Math.abs(seconds) / 60);
  const secs = Math.abs(seconds) % 60;
  const prefix = seconds < 0 ? '-' : '';
  return `${prefix}${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

function startTaskTimer(listIndex, taskIndex){
  // Stop any existing timer first
  if (activeTaskTimer) {
    stopTaskTimer(false);
  }
  
  const task = allLists[listIndex]?.tasks?.[taskIndex];
  if (!task) return;
  
  // Update pet's last active time
  const pet = getPetData();
  if (pet) {
    pet.lastActive = Date.now();
    savePetData(pet);
  }
  
  // Start countdown timer
  activeTaskTimer = {
    listIndex,
    taskIndex,
    startTime: Date.now(),
    intervalId: setInterval(() => renderLists(), 1000)
  };
  renderLists();
}

function stopTaskTimer(save = true){
  if (!activeTaskTimer) return;
  
  clearInterval(activeTaskTimer.intervalId);
  
  if (save) {
    const elapsed = Math.floor((Date.now() - activeTaskTimer.startTime) / 1000);
    const task = allLists[activeTaskTimer.listIndex]?.tasks?.[activeTaskTimer.taskIndex];
    if (task) {
      task.timeSpent = (task.timeSpent || 0) + elapsed;
      saveAllLists();
    }
  }
  
  activeTaskTimer = null;
  renderLists();
}

function getActiveTaskTime(){
  if (!activeTaskTimer) return 0;
  return Math.floor((Date.now() - activeTaskTimer.startTime) / 1000);
}

function getRemainingTime(task){
  const estimateSecs = (task.estimateMinutes || 0) * 60;
  const spent = task.timeSpent || 0;
  return estimateSecs - spent;
}

/* ========== QUICK LINKS MODAL ========== */
function openQuickLinksModal(){
  $('quickLinksOverlay').classList.remove('hidden');
  $('quickLinksModal').classList.remove('hidden');
  renderQuickLinks();
}

function closeQuickLinksModal(){
  $('quickLinksOverlay').classList.add('hidden');
  $('quickLinksModal').classList.add('hidden');
}

/* ========== GRADIENT SELECTION ========== */
const gradientEls = Array.from(document.querySelectorAll('.gradient-option'));
function setPickedBgValue(val){
  pickedBackground = val;
  gradientEls.forEach(el => el.classList.toggle('selected', el.getAttribute('data-bg') === val));
  applyBackgroundPreview(val);
}
function applyBackgroundPreview(val) {
  if (val === 'default') {
    document.body.style.background = 'linear-gradient(135deg, #5b00ff, #ff0066, #00f2ff)';
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'gradientMove 12s ease infinite';
  } else if (val === 'blue-purple-moving') {
    document.body.style.background = 'linear-gradient(135deg, #0066ff, #9933ff, #0066ff)';
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'gradientMove 12s ease infinite';
  } else {
    document.body.style.background = val;
    document.body.style.backgroundSize = '';
    document.body.style.animation = '';
  }
}
gradientEls.forEach(el => el.addEventListener('click', ()=> setPickedBgValue(el.getAttribute('data-bg'))));
function useDefaultNow(){ setPickedBgValue('default'); }

/* ========== PANEL TOGGLE ========== */
function togglePanel(panelId){
  const panel = $(panelId);
  const body = $(panelId + 'Body');
  if (!panel || !body) return;
  const open = body.classList.contains('open');
  if (open) {
    body.style.maxHeight = body.scrollHeight + 'px';
    requestAnimationFrame(()=> {
      body.style.maxHeight = '0px';
      body.classList.remove('open');
      panel.classList.remove('open');
    });
  } else {
    body.classList.add('open');
    panel.classList.add('open');
    body.style.maxHeight = body.scrollHeight + 'px';
    setTimeout(()=> { if (body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }, 330);
  }
}

/* ========== TOP PANELS VISIBILITY ========== */
function checkTopPanelsVisibility(){
  const top = $('topPanels');
  const leftPanel = $('leftPanel');
  const planner = $('planner');

  if (!currentUser) {
    if (top) {
      top.classList.add('hidden');
      top.setAttribute('aria-hidden', 'true');
    }
    if (leftPanel) leftPanel.classList.add('hidden');
    if (planner) planner.classList.add('hidden');
    return;
  }

  if (top) {
    top.classList.remove('hidden');
    top.setAttribute('aria-hidden', 'false');
  }
  if (leftPanel) leftPanel.classList.remove('hidden');
  if (planner) planner.classList.remove('hidden');
}

/* ========== ACCOUNTS ========== */
async function createAccount(){
  const user = $('username').value.trim();
  const pass = $('password').value.trim();
  if (!user || !pass) { alert('Please fill both username and password'); return; }
  
  const userData = {
    username: user,
    password: pass,
    lists: [{ name: 'My First List', tasks: [] }],
    background: pickedBackground,
    quickLinks: [],
    planner: [],
    palette: [],
    journal: '',
    pet: { 
      name: 'Pixel', 
      emoji: 'üê±', 
      happiness: 0, 
      xp: 0, 
      level: 1, 
      accessory: '', 
      lastActive: Date.now(),
      tasksToday: 0,
      lastTaskDate: getTodayStr()
    }
  };
  
  // Try cloud signup first
  const cloudResult = await cloudSignup(user, pass, userData);
  if (cloudResult.error) {
    alert(cloudResult.error);
    return;
  }
  
  // Save locally too
  const users = getUsers();
  users[user] = userData;
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('currentUser', user);
  currentUser = user; 
  currentUserName = user;
  loadAllLists();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
  renderPet();
  checkTopPanelsVisibility();
  startPetDecay();
}

function showLogin(){ $('signup').classList.add('hidden'); $('login').classList.remove('hidden'); }
function showSignup(){ $('login').classList.add('hidden'); $('signup').classList.remove('hidden'); }

async function login(){
  const userInput = $('loginUsername').value.trim();
  const pass = $('loginPassword').value.trim();
  
  // Try cloud login first
  const cloudUser = await cloudLogin(userInput, pass);
  
  if (cloudUser) {
    // Sync cloud data to local
    const users = getUsers();
    users[userInput] = cloudUser.data;
    localStorage.setItem('users', JSON.stringify(users));
    
    localStorage.setItem('currentUser', userInput);
    currentUser = userInput; 
    currentUserName = cloudUser.data.username || userInput;
    loadAllLists();
    showTodo();
    renderLists();
    renderQuickLinks();
    renderPlanner();
    renderPet();
    updatePetHappinessFromTasks();
    checkTopPanelsVisibility();
    startPetDecay();
    showNewQuote();
    console.log('‚úÖ Logged in from cloud');
    return;
  }
  
  // Fall back to local login
  const users = getUsers();
  if (!users[userInput] || users[userInput].password !== pass) { 
    alert('Invalid username or password'); 
    return; 
  }
  
  localStorage.setItem('currentUser', userInput);
  currentUser = userInput; 
  currentUserName = users[userInput].username || userInput;
  loadAllLists();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
  renderPet();
  updatePetHappinessFromTasks();
  checkTopPanelsVisibility();
  startPetDecay();
  showNewQuote();
}

/* ========== SHOW TODO ========== */
function showTodo(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return;
  const user = users[currentUser];
  applyBackgroundPreview(user.background || 'default');
  $('signup').classList.add('hidden');
  $('login').classList.add('hidden');
  $('todo').classList.remove('hidden');

  const displayName = currentUserName || currentUser;
  $('todoHeader').innerHTML = `
    <h1>Welcome, ${escapeHtml(displayName)}!</h1>
    <div style="margin-top:8px">
      <button onclick="createNewList()" class="list-button">+ New To-Do List</button>
      <button class="control-small" onclick="resetCompletedTasks()">Reset Tasks</button>
      <button class="control-small" onclick="openBackgroundPicker()">Change background</button>
      <button class="control-small" onclick="spinTaskWheel()">üé° Random Task</button>
    </div>
  `;
  
  showNewQuote();
  resetTimer();
}

/* ========== BACKGROUND PICKER ========== */
function openBackgroundPicker(){
  const picker = $('background-picker');
  picker.classList.toggle('hidden');
}

function changeBackground(value){
  applyBackgroundPreview(value);
  const users = getUsers();
  if (currentUser && users[currentUser]) {
    users[currentUser].background = value;
    saveUsers(users);
  }
}

/* ========== QUICK LINKS ========== */
function renderQuickLinks(){
  const listEl = $('quickLinksList');
  if (!listEl) return;
  listEl.innerHTML = '';

  if (!currentUser) return;

  const users = getUsers();
  const links = (users[currentUser] && users[currentUser].quickLinks) || [];
  
  if (links.length === 0) {
    listEl.innerHTML = '<li style="opacity:0.7; font-style:italic;">No quick links yet</li>';
    return;
  }
  
  links.forEach((link, i) => {
    const li = document.createElement('li');
    li.innerHTML = `
      <a href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link.name)}</a>
      <div>
        <button class="small-btn" onclick="removeQuickLink(${i})">üóë</button>
      </div>`;
    listEl.appendChild(li);
  });
}

function addQuickLink(){
  const name = $('quickLinkName').value.trim();
  let url = $('quickLinkURL').value.trim();
  if (!name || !url) { alert('Please enter both a name and a URL'); return; }
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return alert('No user session');
  users[currentUser].quickLinks = users[currentUser].quickLinks || [];
  users[currentUser].quickLinks.push({ name, url });
  saveUsers(users);
  $('quickLinkName').value=''; $('quickLinkURL').value='';
  renderQuickLinks();
}

function removeQuickLink(index){
  const users = getUsers();
  if (!currentUser || !users[currentUser] || !users[currentUser].quickLinks) return;
  users[currentUser].quickLinks.splice(index,1);
  saveUsers(users);
  renderQuickLinks();
}

function clearQuickLinks(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].quickLinks = [];
  saveUsers(users);
  renderQuickLinks();
}

/* ========== JOURNAL ========== */
function openJournalModal(){
  const users = getUsers();
  const journal = users[currentUser]?.journal || '';
  $('journalTextarea').value = journal;
  $('journalOverlay').classList.remove('hidden');
  $('journalModal').classList.remove('hidden');
}

function closeJournalModal(){
  $('journalOverlay').classList.add('hidden');
  $('journalModal').classList.add('hidden');
}

function saveJournal(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].journal = $('journalTextarea').value;
  saveUsers(users);
  closeJournalModal();
}

/* ========== RESET COMPLETED TASKS ========== */
function resetCompletedTasks(){
  // Stop any active timer first
  if (activeTaskTimer) {
    stopTaskTimer(false);
  }
  
  // Filter out completed tasks from each list
  for (let i = 0; i < allLists.length; i++) {
    allLists[i].tasks = allLists[i].tasks.filter(task => !task.done);
  }
  
  saveAllLists();
  renderLists();
  renderPlanner();
}

/* ========== TASK WHEEL ========== */
function spinTaskWheel(){
  // Gather all unfinished tasks from all lists
  const unfinishedTasks = [];
  allLists.forEach((list, listIndex) => {
    list.tasks.forEach((task, taskIndex) => {
      if (!task.done) {
        unfinishedTasks.push({
          text: task.text,
          listName: list.name,
          listIndex,
          taskIndex
        });
      }
    });
  });
  
  if (unfinishedTasks.length === 0) {
    $('wheelEmoji').textContent = 'üéâ';
    $('wheelResult').textContent = 'No unfinished tasks! You\'re all done!';
    $('wheelListName').textContent = '';
    $('taskWheelOverlay').classList.remove('hidden');
    $('taskWheelPopup').classList.remove('hidden');
    return;
  }
  
  // Show the popup
  $('taskWheelOverlay').classList.remove('hidden');
  $('taskWheelPopup').classList.remove('hidden');
  $('wheelResult').textContent = 'Spinning...';
  $('wheelListName').textContent = '';
  
  // Animate the wheel emoji
  const wheelEmoji = $('wheelEmoji');
  wheelEmoji.textContent = 'üé°';
  wheelEmoji.classList.remove('wheel-spinning');
  void wheelEmoji.offsetWidth; // Force reflow
  wheelEmoji.classList.add('wheel-spinning');
  
  // After spin animation, show random task
  setTimeout(() => {
    const randomTask = unfinishedTasks[Math.floor(Math.random() * unfinishedTasks.length)];
    wheelEmoji.classList.remove('wheel-spinning');
    wheelEmoji.textContent = 'üéØ';
    $('wheelResult').textContent = randomTask.text;
    $('wheelListName').textContent = `From: ${randomTask.listName}`;
    
    // Switch to that list
    activeListIndex = randomTask.listIndex;
    renderLists();
  }, 2000);
}

function closeTaskWheel(){
  $('taskWheelOverlay').classList.add('hidden');
  $('taskWheelPopup').classList.add('hidden');
}

/* ========== PLANNER ========== */
let plannerView = 'weekly';

function switchPlannerView(view){
  plannerView = view;
  if (view === 'weekly') {
    $('plannerGrid').classList.remove('hidden');
    $('monthlyGrid').classList.add('hidden');
    $('plannerViewLabel').textContent = 'Week: Sunday ‚Üí Saturday';
  } else {
    $('plannerGrid').classList.add('hidden');
    $('monthlyGrid').classList.remove('hidden');
    const now = new Date();
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    $('plannerViewLabel').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;
  }
  renderPlanner();
  
  // Force panel body to recalculate height
  const plannerBody = $('plannerBody');
  if (plannerBody) {
    plannerBody.style.maxHeight = 'none';
    plannerBody.style.maxHeight = plannerBody.scrollHeight + 'px';
  }
}

function formatDate(d) {
  const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
}

function renderPlanner(){
  const grid = $('plannerGrid');
  const paletteRow = $('paletteRow');
  if (!grid || !paletteRow) return;

  if (!currentUser) return;

  grid.innerHTML = '';
  
  // Skip weekly grid rendering if monthly view is active
  if (plannerView === 'monthly') {
    // Just gather tasks and render monthly
    const allTasksWithDates = [];
    allLists.forEach((list, listIndex) => {
      list.tasks.forEach((task, taskIndex) => {
        if (task.dueDate) {
          allTasksWithDates.push({
            text: task.text,
            dueDate: task.dueDate,
            done: task.done,
            color: task.color,
            listIndex,
            taskIndex,
            listName: list.name
          });
        }
      });
    });
    renderMonthlyPlanner(allTasksWithDates);
    renderPalette(paletteRow);
    return;
  }

  const today = new Date();
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay());
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startOfWeek);
    d.setDate(startOfWeek.getDate() + i);
    weekDates.push(d);
  }

  const users = getUsers();
  const user = users[currentUser] || { palette: [] };
  const palette = user.palette || [];

  // Gather all tasks with due dates from all lists
  const allTasksWithDates = [];
  allLists.forEach((list, listIndex) => {
    list.tasks.forEach((task, taskIndex) => {
      if (task.dueDate) {
        allTasksWithDates.push({
          text: task.text,
          dueDate: task.dueDate,
          done: task.done,
          color: task.color,
          listIndex,
          taskIndex,
          listName: list.name
        });
      }
    });
  });

  for (let day = 0; day < 7; day++){
    const col = document.createElement('div');
    col.className = 'day-col';

    const d = weekDates[day];
    const dayLabel = formatDate(d);
    const header = document.createElement('div');
    header.className = 'day-header';
    header.textContent = dayLabel;
    col.appendChild(header);

    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const date = String(d.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${date}`;
    
    const dayTasks = allTasksWithDates.filter(t => t.dueDate === dateStr);

    dayTasks.forEach((task) => {
      const taskColor = task.color || (task.done ? '#6bcb77' : '#ffd166');
      
      const pill = document.createElement('div');
      pill.className = 'task-pill';
      pill.style.background = taskColor;
      pill.style.color = readableTextColor(taskColor);
      pill.style.opacity = task.done ? '0.7' : '1';
      pill.title = `${task.text} (${task.listName})${task.done ? ' ‚úì' : ''}`;

      const label = document.createElement('div');
      label.className = 'task-label';
      label.textContent = task.done ? `‚úì ${task.text}` : task.text;
      label.style.textDecoration = task.done ? 'line-through' : 'none';

      const settingsBtn = document.createElement('button');
      settingsBtn.textContent = '‚öôÔ∏è';
      settingsBtn.className = 'small-btn';
      settingsBtn.style.padding = '2px 5px';
      settingsBtn.style.fontSize = '10px';
      settingsBtn.style.background = 'rgba(255,255,255,0.3)';
      settingsBtn.title = 'Change color';
      settingsBtn.onclick = (e) => {
        e.stopPropagation();
        openTaskColorPicker(task.listIndex, task.taskIndex);
      };

      pill.appendChild(label);
      pill.appendChild(settingsBtn);
      col.appendChild(pill);
    });

    if(dayTasks.length === 0){
      const empty = document.createElement('div');
      empty.style.opacity = '0.5';
      empty.style.fontSize = '11px';
      empty.textContent = '‚Äî';
      col.appendChild(empty);
    }

    grid.appendChild(col);
  }

  // Render palette
  renderPalette(paletteRow);
}

function renderPalette(paletteRow){
  const users = getUsers();
  const user = users[currentUser] || { palette: [] };
  const palette = user.palette || [];
  
  paletteRow.innerHTML = '';
  if (palette.length === 0) {
    paletteRow.innerHTML = '<span style="font-size:11px; opacity:0.6;">No colors saved</span>';
  } else {
    palette.forEach(p => {
      const container = document.createElement('div');
      container.className = 'swatch-container';
      
      const s = document.createElement('div');
      s.className = 'swatch';
      s.title = p.label || '';
      s.style.background = p.color || '#fff';
      s.onclick = () => { 
        if ($('taskColor')) $('taskColor').value = p.color;
        if ($('taskColorPreview')) $('taskColorPreview').style.background = p.color;
      };
      
      const labelEl = document.createElement('div');
      labelEl.className = 'swatch-label';
      labelEl.textContent = p.label || '';
      
      container.appendChild(s);
      container.appendChild(labelEl);
      paletteRow.appendChild(container);
    });
  }
}

function renderMonthlyPlanner(allTasksWithDates){
  const monthlyGrid = $('monthlyGrid');
  if (!monthlyGrid) return;
  monthlyGrid.innerHTML = '';
  
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // Day headers
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  dayNames.forEach(name => {
    const header = document.createElement('div');
    header.className = 'month-day-header';
    header.textContent = name;
    monthlyGrid.appendChild(header);
  });
  
  // First day of month
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const startPadding = firstDay.getDay();
  
  // Previous month padding
  const prevMonth = new Date(currentYear, currentMonth, 0);
  for (let i = startPadding - 1; i >= 0; i--) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'month-day other-month';
    const dayNum = document.createElement('div');
    dayNum.className = 'month-day-num';
    dayNum.textContent = prevMonth.getDate() - i;
    dayDiv.appendChild(dayNum);
    monthlyGrid.appendChild(dayDiv);
  }
  
  // Current month days
  for (let d = 1; d <= lastDay.getDate(); d++) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'month-day';
    if (d === today.getDate() && currentMonth === today.getMonth()) {
      dayDiv.classList.add('today');
    }
    
    const dayNum = document.createElement('div');
    dayNum.className = 'month-day-num';
    dayNum.textContent = d;
    dayDiv.appendChild(dayNum);
    
    // Find tasks for this day
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayTasks = allTasksWithDates.filter(t => t.dueDate === dateStr);
    
    dayTasks.slice(0, 3).forEach(task => {
      const taskDiv = document.createElement('div');
      taskDiv.className = 'month-task';
      taskDiv.style.background = task.color || (task.done ? '#6bcb77' : '#ffd166');
      taskDiv.style.color = readableTextColor(task.color || '#ffd166');
      taskDiv.textContent = task.text;
      taskDiv.title = task.text;
      if (task.done) taskDiv.style.opacity = '0.6';
      dayDiv.appendChild(taskDiv);
    });
    
    if (dayTasks.length > 3) {
      const more = document.createElement('div');
      more.style.fontSize = '9px';
      more.style.opacity = '0.7';
      more.textContent = `+${dayTasks.length - 3} more`;
      dayDiv.appendChild(more);
    }
    
    monthlyGrid.appendChild(dayDiv);
  }
  
  // Next month padding
  const endPadding = 6 - lastDay.getDay();
  for (let i = 1; i <= endPadding; i++) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'month-day other-month';
    const dayNum = document.createElement('div');
    dayNum.className = 'month-day-num';
    dayNum.textContent = i;
    dayDiv.appendChild(dayNum);
    monthlyGrid.appendChild(dayDiv);
  }
}

function readableTextColor(hex){
  try{
    const c = hex.replace('#','');
    const r = parseInt(c.substring(0,2),16);
    const g = parseInt(c.substring(2,4),16);
    const b = parseInt(c.substring(4,6),16);
    const lum = 0.2126*r + 0.7152*g + 0.0722*b;
    return lum > 150 ? '#071019' : '#ffffff';
  } catch(e){ return '#071019'; }
}

/* ========== TASK COLOR PICKER ========== */
let editingTaskColor = { listIndex: -1, taskIndex: -1 };

function openTaskColorPicker(listIndex, taskIndex){
  const task = allLists[listIndex]?.tasks?.[taskIndex];
  if (!task) return;
  
  editingTaskColor = { listIndex, taskIndex };
  
  const currentColor = task.color || '#ffd166';
  $('taskColorInput').value = currentColor;
  $('taskColorPreviewBox').style.background = currentColor;
  $('taskColorName').textContent = task.text;
  
  // Render palette swatches
  const paletteDiv = $('taskColorPalette');
  paletteDiv.innerHTML = '';
  
  const users = getUsers();
  const palette = users[currentUser]?.palette || [];
  
  if (palette.length === 0) {
    paletteDiv.innerHTML = '<span style="font-size:11px; opacity:0.6;">No saved colors</span>';
  } else {
    palette.forEach(p => {
      const s = document.createElement('div');
      s.className = 'swatch';
      s.title = p.label || '';
      s.style.background = p.color || '#fff';
      s.onclick = () => {
        $('taskColorInput').value = p.color;
        $('taskColorPreviewBox').style.background = p.color;
      };
      paletteDiv.appendChild(s);
    });
  }
  
  $('taskColorOverlay').classList.remove('hidden');
  $('taskColorModal').classList.remove('hidden');
}

function closeTaskColorPicker(){
  $('taskColorOverlay').classList.add('hidden');
  $('taskColorModal').classList.add('hidden');
  editingTaskColor = { listIndex: -1, taskIndex: -1 };
}

function saveTaskColor(){
  const { listIndex, taskIndex } = editingTaskColor;
  const task = allLists[listIndex]?.tasks?.[taskIndex];
  if (!task) return;
  
  task.color = $('taskColorInput').value;
  saveAllLists();
  closeTaskColorPicker();
  renderPlanner();
  renderLists();
}

// Update color preview when input changes
document.addEventListener('DOMContentLoaded', () => {
  const colorInput = $('taskColorInput');
  if (colorInput) {
    colorInput.addEventListener('input', () => {
      $('taskColorPreviewBox').style.background = colorInput.value;
    });
  }
});

function addPaletteColor(){
  const label = $('paletteLabel').value.trim();
  const color = $('paletteColor').value;
  if (!label) { alert('Label required'); return; }
  if (!currentUser) return;
  
  const users = getUsers();
  if (!users[currentUser]) return;
  
  users[currentUser].palette = users[currentUser].palette || [];
  users[currentUser].palette.push({ id: Date.now(), label, color });
  saveUsers(users);
  $('paletteLabel').value = '';
  renderPlanner();
}

function clearPalette(){
  const users = getUsers();
  if (!users[currentUser]) return;
  users[currentUser].palette = [];
  saveUsers(users);
  renderPlanner();
}

/* ========== TASK DIALOG ========== */
function renderDialogPalette(){
  const row = $('dialogPaletteRow');
  if (!row) return;
  row.innerHTML = '';
  
  const users = getUsers();
  const palette = users[currentUser]?.palette || [];
  
  palette.forEach(p => {
    const s = document.createElement('div');
    s.className = 'swatch';
    s.title = p.label;
    s.style.background = p.color;
    s.onclick = () => {
      $('taskColor').value = p.color;
      $('taskColorPreview').style.background = p.color;
    };
    row.appendChild(s);
  });
}

function openEditTaskDialog(taskId){
  const users = getUsers();
  const tasks = users[currentUser]?.planner || [];
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  
  $('taskDialogTitle').textContent = 'Edit Task';
  $('taskText').value = task.text || '';
  $('taskColor').value = task.color || '#ffd166';
  $('taskColorPreview').style.background = task.color || '#ffd166';
  $('taskDialog').dataset.editId = String(taskId);
  renderDialogPalette();
  $('taskDialog').classList.remove('hidden');
}

function closeTaskDialog(){ 
  $('taskDialog').classList.add('hidden'); 
  $('taskDialog').dataset.editId = ''; 
}

$('taskColor')?.addEventListener?.('input', () => {
  $('taskColorPreview').style.background = $('taskColor').value;
});

function saveTaskFromDialog(){
  const text = $('taskText').value.trim();
  if (!text) return alert('Enter task text');
  const color = $('taskColor').value || '#ffd166';
  
  const users = getUsers();
  users[currentUser].planner = users[currentUser].planner || [];
  
  const editId = $('taskDialog').dataset.editId;
  if (editId) {
    const idx = users[currentUser].planner.findIndex(t => String(t.id) === editId);
    if (idx >= 0) {
      users[currentUser].planner[idx].text = text;
      users[currentUser].planner[idx].color = color;
    }
  } else {
    users[currentUser].planner.push({ id: Date.now(), text, color });
  }
  
  saveUsers(users);
  closeTaskDialog();
  renderPlanner();
}

/* ========== LISTS ========== */
let currentSortOrder = 'default';

function saveAllLists(){
  if (!currentUser) return;
  const users = getUsers();
  if (users[currentUser]) {
    users[currentUser].lists = allLists;
    saveUsers(users);
  }
}

function getDifficultyValue(difficulty){
  switch(difficulty){
    case 'really-easy': return 1;
    case 'easy': return 2;
    case 'medium': return 3;
    case 'hard': return 4;
    case 'insane': return 5;
    default: return 3;
  }
}

function getSortedTasks(tasks){
  // Create array with original indices
  const tasksWithIndex = tasks.map((task, index) => ({ task, originalIndex: index }));
  
  switch(currentSortOrder){
    case 'oldest':
      // Reverse order (oldest first since newest is default)
      return tasksWithIndex.reverse();
    case 'due-date':
      return tasksWithIndex.sort((a, b) => {
        const dateA = a.task.dueDate || '9999-99-99';
        const dateB = b.task.dueDate || '9999-99-99';
        if (dateA === dateB) {
          // Secondary sort: shortest tasks first
          return (a.task.estimateMinutes || 999) - (b.task.estimateMinutes || 999);
        }
        return dateA.localeCompare(dateB);
      });
    case 'shortest':
      return tasksWithIndex.sort((a, b) => {
        return (a.task.estimateMinutes || 999) - (b.task.estimateMinutes || 999);
      });
    case 'easiest':
      return tasksWithIndex.sort((a, b) => {
        return getDifficultyValue(a.task.difficulty) - getDifficultyValue(b.task.difficulty);
      });
    case 'hardest':
      return tasksWithIndex.sort((a, b) => {
        return getDifficultyValue(b.task.difficulty) - getDifficultyValue(a.task.difficulty);
      });
    default:
      return tasksWithIndex;
  }
}

function sortTasks(sortOrder){
  currentSortOrder = sortOrder;
  renderActiveList();
  // Re-set the dropdown value since renderActiveList rebuilds it
  const select = $('taskSortSelect');
  if (select) select.value = sortOrder;
}

function loadAllLists(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) { allLists = []; return; }
  allLists = users[currentUser].lists || [];
  allLists = allLists.map(l => (typeof l === 'string' ? { name: l, tasks: [] } : (l.name ? l : { name: 'Untitled', tasks: l.tasks || [] })));
  activeListIndex = 0;
}

function renderLists(){
  renderTabs();
  renderActiveList();
}

function renderTabs(){
  const tabs = $('tabsContainer'); 
  tabs.innerHTML = '';
  allLists.forEach((list, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i === activeListIndex ? ' active' : '');
    btn.textContent = list.name || `List ${i+1}`;
    btn.onclick = () => { activeListIndex = i; renderLists(); };
    tabs.appendChild(btn);
    
    const renameBtn = document.createElement('button');
    renameBtn.className = 'control-small';
    renameBtn.textContent = '‚úèÔ∏è';
    renameBtn.onclick = (e) => { e.stopPropagation(); renameList(i); };
    tabs.appendChild(renameBtn);
    
    const delBtn = document.createElement('button');
    delBtn.className = 'control-small';
    delBtn.textContent = 'üóë';
    delBtn.onclick = (e) => { e.stopPropagation(); confirmDeleteList(i); };
    tabs.appendChild(delBtn);
  });
}

function renderActiveList(){
  const container = $('listsContainer'); 
  container.innerHTML = '';
  
  if (allLists.length === 0){
    container.innerHTML = `<div style="padding:20px; border-radius:12px; background: rgba(0,0,0,0.15)">
      <h2>No To-Do Lists Yet üòé</h2>
      <p>Click "+ New To-Do List" to start.</p>
    </div>`;
    return;
  }
  
  const index = activeListIndex;
  const list = allLists[index];
  
  if (!list) {
    activeListIndex = 0;
    return renderActiveList();
  }
  
  const listDiv = document.createElement('div');
  listDiv.innerHTML = `
    <h2 style="margin-bottom:6px">${escapeHtml(list.name)}</h2>
    <div style="margin-bottom:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
      <input type="text" id="newTask_${index}" placeholder="Add a task..." style="flex:1; min-width:150px;">
      <select id="newTaskDifficulty_${index}" title="How hard is this task?" style="padding:8px; border-radius:6px;">
        <option value="really-easy">üòå Really Easy</option>
        <option value="easy">üôÇ Easy</option>
        <option value="medium" selected>üòê Medium</option>
        <option value="hard">üò§ Hard</option>
        <option value="insane">ü§Ø INSANE</option>
      </select>
      <input type="number" id="newTaskEstimate_${index}" placeholder="Est. min" min="1" max="999" style="width:80px;" title="Estimated minutes">
      <input type="date" id="newTaskDate_${index}">
      <button onclick="addTask(${index})">Add</button>
    </div>
    <div style="margin-bottom:8px; display:flex; gap:6px; align-items:center;">
      <span style="font-size:12px; opacity:0.8;">Sort by:</span>
      <select id="taskSortSelect" onchange="sortTasks(this.value)" style="padding:6px; border-radius:6px; font-size:12px;">
        <option value="default">Default (Newest First)</option>
        <option value="oldest">Oldest First</option>
        <option value="due-date">Due Date</option>
        <option value="shortest">Shortest Tasks</option>
        <option value="easiest">Easiest First</option>
        <option value="hardest">Hardest First</option>
      </select>
    </div>
    <ul id="list_${index}"></ul>
  `;
  container.appendChild(listDiv);
  
  const ul = $('list_' + index);
  
  // Get sorted tasks with original indices
  const sortedTasks = getSortedTasks(list.tasks);
  
  sortedTasks.forEach(({ task, originalIndex }) => {
    const tIdx = originalIndex;
    const li = document.createElement('li');
    
    const isTimerActive = activeTaskTimer && activeTaskTimer.listIndex === index && activeTaskTimer.taskIndex === tIdx;
    const activeElapsed = isTimerActive ? getActiveTaskTime() : 0;
    const totalSpent = (task.timeSpent || 0) + activeElapsed;
    const estimateSecs = (task.estimateMinutes || 0) * 60;
    
    // Calculate remaining time (countdown)
    const remainingTime = estimateSecs - totalSpent;
    const timerColor = remainingTime < 0 ? '#ff6b6b' : (remainingTime < 60 ? '#ffd93d' : 'inherit');
    
    const dateLabel = task.dueDate ? `<span style="font-size:11px; opacity:0.8; margin-right:6px;">üìÖ ${task.dueDate}</span>` : '';
    const difficultyEmoji = getDifficultyEmoji(task.difficulty);
    const difficultyLabel = `<span style="font-size:14px; margin-right:4px;" title="${task.difficulty || 'medium'}">${difficultyEmoji}</span>`;
    
    // Show countdown if estimate exists, otherwise show time spent
    const timeDisplay = task.estimateMinutes 
      ? `<span class="task-time-display" style="color:${timerColor}">${formatTime(remainingTime)}</span>`
      : `<span class="task-time-display">${formatTime(totalSpent)}</span>`;
    
    li.innerHTML = `
      <div class="task-row">
        <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${tIdx})" style="margin:0;">
        ${difficultyLabel}
        <input type="text" value="${escapeHtml(task.text)}" onchange="editTask(${tIdx}, this.value)" 
               style="text-decoration: ${task.done ? 'line-through' : 'none'}; flex:1; min-width:100px;">
        ${dateLabel}
        <div class="task-timer-section">
          ${timeDisplay}
          ${isTimerActive 
            ? `<button class="task-start-btn running" onclick="stopTaskTimer()">‚èπ Stop</button>`
            : `<button class="task-start-btn" onclick="startTaskTimer(${index}, ${tIdx})">‚ñ∂ Start</button>`
          }
        </div>
        <button onclick="deleteTask(${index}, ${tIdx})" style="padding:6px 10px;">üóëÔ∏è</button>
      </div>
    `;
    ul.appendChild(li);
  });
}

function createNewList(){ 
  allLists.push({ name: `List ${allLists.length + 1}`, tasks: [] }); 
  saveAllLists(); 
  activeListIndex = allLists.length - 1; 
  renderLists(); 
}

function renameList(listIndex){ 
  const newName = prompt("New name:", allLists[listIndex].name || `List ${listIndex+1}`); 
  if (newName && newName.trim() !== ""){ 
    allLists[listIndex].name = newName.trim(); 
    saveAllLists(); 
    renderLists(); 
  } 
}

function confirmDeleteList(listIndex){ 
  allLists.splice(listIndex, 1); 
  if(allLists.length === 0) activeListIndex = 0; 
  else if(activeListIndex >= allLists.length) activeListIndex = allLists.length - 1; 
  saveAllLists(); 
  renderLists(); 
}

function addTask(listIndex){
  const input = $('newTask_' + listIndex);
  const dateInput = $('newTaskDate_' + listIndex);
  const estimateInput = $('newTaskEstimate_' + listIndex);
  const difficultyInput = $('newTaskDifficulty_' + listIndex);
  const text = input.value.trim();
  const dueDate = dateInput ? dateInput.value : '';
  const estimateMinutes = estimateInput ? parseInt(estimateInput.value) || 0 : 0;
  const difficulty = difficultyInput ? difficultyInput.value : 'medium';

  if (!text) return;

  allLists[listIndex].tasks.push({ 
    text, 
    done: false, 
    dueDate: dueDate || undefined, 
    timeSpent: 0,
    estimateMinutes: estimateMinutes || undefined,
    difficulty: difficulty
  });

  input.value = "";
  if(dateInput) dateInput.value = "";
  if(estimateInput) estimateInput.value = "";
  if(difficultyInput) difficultyInput.value = "medium";

  saveAllLists();
  renderLists();
  renderPlanner(); // Sync planner with tasks
}

function toggleTask(taskIndex){ 
  const task = allLists[activeListIndex].tasks[taskIndex];
  const wasNotDone = !task.done;
  task.done = !task.done;
  
  // If completing a task, stop its timer, update pet, and show popup with confetti
  if (task.done && wasNotDone) {
    if (activeTaskTimer && activeTaskTimer.listIndex === activeListIndex && activeTaskTimer.taskIndex === taskIndex) {
      stopTaskTimer();
    }
    incrementTasksToday();
    showCompletionPopup();
    
    // Show confetti based on difficulty
    const difficulty = task.difficulty || 'medium';
    if (difficulty === 'insane' || difficulty === 'hard') {
      showConfetti(100); // Full confetti
    } else if (difficulty === 'medium') {
      showConfetti(40); // Less confetti
    }
    // Easy and really-easy: no confetti, just the message
  }
  
  saveAllLists(); 
  renderLists();
  renderPlanner(); // Sync planner
}

function editTask(taskIndex, newText){
  allLists[activeListIndex].tasks[taskIndex].text = newText;
  saveAllLists();
  renderPlanner(); // Sync planner
}

function deleteTask(listIndex, taskIndex) {
  if (!allLists[listIndex]?.tasks?.[taskIndex]) return;
  
  // Stop timer if active
  if (activeTaskTimer && activeTaskTimer.listIndex === listIndex && activeTaskTimer.taskIndex === taskIndex) {
    stopTaskTimer(false);
  }

  allLists[listIndex].tasks.splice(taskIndex, 1);
  saveAllLists();
  renderLists();
  renderPlanner(); // Sync planner
}

/* ========== LOGOUT ========== */
function logout(){
  stopTaskTimer(true);
  saveAllLists();
  if (petDecayInterval) clearInterval(petDecayInterval);
  localStorage.removeItem('currentUser');
  currentUser = null; 
  currentUserName = null; 
  allLists = []; 
  activeListIndex = 0;
  setPickedBgValue('default');
  $('todo').classList.add('hidden'); 
  $('login').classList.remove('hidden');
  $('listsContainer').innerHTML = ''; 
  $('tabsContainer').innerHTML = ''; 
  $('todoHeader').innerHTML = '';
  $('background-picker')?.classList.add('hidden');
  closeQuickLinksModal();
  checkTopPanelsVisibility();
}

/* ========== INIT ========== */
function initPage(){
  currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    const users = getUsers();
    if (users[currentUser]) {
      currentUserName = users[currentUser].username || null;
      loadAllLists();
      showTodo();
      renderLists();
      renderQuickLinks();
      renderPlanner();
      renderPet();
      updatePetHappinessFromTasks();
      startPetDecay();
    } else {
      localStorage.removeItem('currentUser');
      currentUser = null;
      $('signup').classList.remove('hidden');
    }
  } else {
    $('signup').classList.remove('hidden');
  }
  checkTopPanelsVisibility();
}

window.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
