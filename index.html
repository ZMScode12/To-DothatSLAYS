<!DOCTYPE html>
<html>
<head>
  <title>Dynamic To-Do Tabs üòé</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --default-moving: linear-gradient(135deg, #5b00ff, #ff0066, #00f2ff); }

    body {
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      padding: 40px;
      transition: background 0.6s ease;
      background: var(--default-moving);
      background-size: 400% 400%;
      animation: gradientMove 12s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .hidden { display: none; }
    input, button, select { padding: 10px; margin: 6px; border-radius: 8px; border: none; font-size: 15px; }
    button { cursor: pointer; }
    .list-button { background-color: white; color: #6b5bff; }

    ul { list-style: none; padding: 0; margin-top: 10px; }
    li { margin: 10px; background: rgba(255,255,255,0.14); padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    input[type="text"] { flex: 1; margin-left: 10px; border-radius:6px; padding:8px; border:none; }

    .gradient-option { width: 86px; height: 44px; border-radius: 10px; display: inline-block; margin: 6px; cursor: pointer; border: 3px solid transparent; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .gradient-option.selected { border-color: white; transform: translateY(-3px); }

    .tabs { margin-bottom: 18px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }
    .tab-btn { background: rgba(255,255,255,0.12); color: white; border-radius: 12px; padding: 8px 12px; cursor: pointer; display:inline-flex; align-items:center; gap:6px; border: none; }
    .tab-btn.active { background: white; color: #6b5bff; font-weight:600; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }

    .control-small { padding:6px 8px; font-size:14px; border-radius:8px; }
    .small-btn { padding:6px 10px; font-size:13px; border-radius:6px; cursor:pointer; }

    #topPanels {
      display: flex;
      gap: 20px;
      justify-content: space-between;
      align-items: flex-start;
      width: calc(100% - 80px);
      margin: 0 auto 18px auto;
      box-sizing: border-box;
      max-width: 1200px;
    }

    .panel {
      width: 48%;
      background: rgba(0, 0, 0, 0.32);
      border-radius: 12px;
      color: white;
      text-align: left;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      overflow: visible;
    }

    .panel-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      border-radius: 12px;
      background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02));
      font-weight: 600;
      gap:8px;
    }
    .panel-header .title { text-align:center; flex:1; font-size:16px; }
    .chev { width:20px; height:20px; display:inline-block; transition: transform 220ms ease; }

    .panel-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height 320ms cubic-bezier(.25,.8,.25,1), padding 220ms ease;
      padding: 0 12px;
    }
    .panel-body.open { padding: 12px; }
    .open .chev { transform: rotate(180deg); }

    #quickLinksList { padding-left: 6px; max-height: 240px; overflow-y: auto; margin-bottom: 8px; }
    #quickLinksList li { display:flex; justify-content: space-between; align-items: center; gap:8px; margin-bottom:6px; font-size:14px; }
    #quickLinksList a { color: #ffd; text-decoration: underline; max-width: 160px; word-break: break-word; }

    #plannerGrid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 8px;
      box-sizing: border-box;
    }
    .day-col {
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      min-height: 120px;
      padding: 8px;
      box-sizing: border-box;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .day-header { font-weight:700; font-size:13px; display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .task-pill { display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius: 8px; color: #071019; font-size:13px; justify-content:space-between; }
    .task-label { flex:1; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding-right:6px; }

    #palette { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .palette-row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .swatch { width:34px; height:34px; border-radius:6px; border:2px solid rgba(255,255,255,0.18); cursor:pointer; display:inline-block; box-shadow:0 4px 10px rgba(0,0,0,0.18); }
    .swatch.selected { outline:3px solid rgba(255,255,255,0.12); transform:translateY(-2px); }
    .swatch-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .swatch-label { color: white; font-size: 10px; max-width: 50px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    #addColorForm { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #addColorForm input[type="text"] { width:140px; padding:8px; border-radius:8px; }

    /* ===== VIRTUAL PET ===== */
    #petContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      border-radius: 16px;
      padding: 12px;
      text-align: center;
      z-index: 1000;
      min-width: 120px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    #petDisplay { font-size: 48px; line-height: 1; margin-bottom: 6px; position: relative; }
    #petAccessory { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 24px; }
    #petName { font-size: 12px; font-weight: bold; margin-bottom: 4px; }
    #petLevel { font-size: 10px; opacity: 0.8; margin-bottom: 6px; }
    #happinessBar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
    #happinessFill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcb77); transition: width 0.5s ease; }
    #petMood { font-size: 10px; margin-top: 4px; }
    .pet-bounce { animation: petBounce 0.5s ease; }
    @keyframes petBounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes petSad { 0%,100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
    .pet-sad { animation: petSad 1s ease infinite; }

    /* ===== FLOATING LEFT CONTAINER (Quote + Timer) ===== */
    #floatingLeftContainer {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 280px;
    }

    /* ===== QUOTE BOX ===== */
    #quoteBox {
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 14px 16px;
      font-style: italic;
      position: relative;
      text-align: left;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    #quoteBox.collapsed { display: none; }
    #quoteText { font-size: 13px; line-height: 1.4; margin-bottom: 6px; }
    #quoteAuthor { font-size: 11px; opacity: 0.7; }
    #newQuoteBtn { position: absolute; top: 6px; right: 6px; padding: 3px 6px; font-size: 11px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; color: white; }
    #newQuoteBtn:hover { background: rgba(255,255,255,0.3); }

    /* ===== TIMER ===== */
    #timerContainer {
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      position: relative;
    }
    #timerContainer.collapsed #timerBody { display: none; }
    #timerContainer.collapsed { padding: 10px 14px; }
    #timerHeader { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    #timerHeader.collapsed-header { margin-bottom: 0; }
    #timerTitle { font-weight: 600; font-size: 14px; }
    .hide-btn { padding: 3px 8px; font-size: 11px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; cursor: pointer; color: white; }
    .hide-btn:hover { background: rgba(255,255,255,0.3); }
    #timerDisplay { font-size: 32px; font-weight: bold; font-family: monospace; margin: 8px 0; }
    #timerProgress { width: 100%; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 8px; }
    #timerProgressFill { height: 100%; background: #1DB954; transition: width 1s linear; }
    .timer-btn { padding: 6px 12px; margin: 3px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; }
    .timer-btn.start { background: #1DB954; color: white; }
    .timer-btn.pause { background: #ffd93d; color: #333; }
    .timer-btn.reset { background: rgba(255,255,255,0.2); color: white; }

    /* ===== QUICK LINKS HIDE BUTTON ===== */
    .panel-hide-btn { padding: 2px 6px; font-size: 10px; background: rgba(255,255,255,0.15); border: none; border-radius: 4px; cursor: pointer; color: white; margin-left: 4px; }
    .panel-hide-btn:hover { background: rgba(255,255,255,0.25); }
    #quickLinksToggle { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; cursor: pointer; z-index: 999; font-size: 13px; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.3); }
    #quickLinksToggle:hover { background: rgba(0,0,0,0.6); }

    /* ===== TASK TIME TRACKING ===== */
    .task-timer { display: flex; align-items: center; gap: 6px; font-size: 11px; opacity: 0.9; }
    .task-timer-btn { padding: 3px 8px; font-size: 11px; border-radius: 4px; border: none; cursor: pointer; background: rgba(255,255,255,0.3); }
    .task-timer-btn.active { background: #ff6b6b; color: white; }
    .task-time-display { font-family: monospace; min-width: 50px; }
    .task-total-time { font-size: 10px; opacity: 0.7; margin-left: 4px; }

    @media (max-width: 880px) {
      #topPanels { flex-direction: column; gap: 12px; width: calc(100% - 40px); }
      .panel { width: 100%; }
      body { padding: 20px; }
      #plannerGrid { grid-template-columns: repeat(1, 1fr); }
      #petContainer { bottom: 10px; right: 10px; padding: 8px; min-width: 100px; }
      #petDisplay { font-size: 36px; }
      #floatingLeftContainer { top: 10px; left: 10px; max-width: 200px; }
      #quoteText { font-size: 11px; }
      #timerDisplay { font-size: 24px; }
    }

    #plannerBody { max-width: 500px; overflow-x: auto; overflow-y: hidden; white-space: nowrap; }
  </style>
</head>
<body>

  <!-- Sign up / Login -->
  <div id="signup">
    <h1>Sign Up üí´</h1>
    <input type="text" id="username" placeholder="Enter a username"><br>
    <input type="password" id="password" placeholder="Enter a password"><br>
    <p style="margin-top:8px">Pick your background style (or keep the moving default):</p>
    <div id="gradients">
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff7e5f, #feb47b)" style="background: linear-gradient(to right, #ff7e5f, #feb47b)" title="Sunset"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #2193b0, #6dd5ed)" style="background: linear-gradient(to right, #2193b0, #6dd5ed)" title="Ocean"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #0f2027, #203a43, #2c5364)" style="background: linear-gradient(to right, #0f2027, #203a43, #2c5364)" title="Galaxy"></div>
      <div class="gradient-option" data-bg="linear-gradient(to right, #ff9a9e, #fad0c4)" style="background: linear-gradient(to right, #ff9a9e, #fad0c4)" title="Blossom"></div>
      <div class="gradient-option" data-bg="default" id="defaultOption" style="background: linear-gradient(135deg,#5b00ff,#ff0066,#00f2ff)" title="Keep moving gradient"></div>
    </div>
    <div style="margin-top:8px">
      <button onclick="createAccount()">Create Account</button>
      <button class="control-small" onclick="useDefaultNow()">Don't change ‚Äî keep moving</button>
    </div>
    <p style="margin-top:12px">Already have an account? <a href="#" onclick="showLogin()">Log in</a></p>
  </div>

  <div id="login" class="hidden">
    <h1>Login üí´</h1>
    <input type="text" id="loginUsername" placeholder="Enter username"><br>
    <input type="password" id="loginPassword" placeholder="Enter password"><br>
    <div style="margin-top:8px">
      <button onclick="login()">Log In</button>
      <button class="control-small" onclick="showSignup()">Sign up</button>
    </div>
  </div>

  <!-- Virtual Pet -->
  <div id="petContainer" class="hidden">
    <div id="petDisplay"><span id="petAccessory"></span><span id="petEmoji">üê±</span></div>
    <div id="petName">Pixel</div>
    <div id="petLevel">Level 1 ‚Ä¢ 0 XP</div>
    <div id="happinessBar"><div id="happinessFill" style="width: 100%"></div></div>
    <div id="petMood">üòä Happy!</div>
    <button class="small-btn" onclick="openPetSettings()" style="margin-top:8px; font-size:10px;">‚öôÔ∏è Pet</button>
  </div>

  <!-- Quick Links Toggle (shown when hidden) -->
  <div id="quickLinksToggle" onclick="showQuickLinks()">üìé Show Quick Links</div>

  <!-- Top inline panels -->
  <div id="topPanels" class="hidden" aria-hidden="true">
    <div id="quickLinks" class="panel" aria-hidden="true">
      <div class="panel-header" onclick="togglePanel('quickLinks')">
        <button class="panel-hide-btn" onclick="event.stopPropagation(); hideQuickLinks();">Hide</button>
        <div class="title">Quick Links</div>
        <div class="chev">‚ñæ</div>
      </div>
      <div id="quickLinksBody" class="panel-body" aria-hidden="true">
        <ul id="quickLinksList"></ul>
        <div class="inputs">
          <input type="text" id="quickLinkName" placeholder="Link name (e.g. Spotify)">
          <input type="text" id="quickLinkURL" placeholder="URL (e.g. https://spotify.com)">
          <div class="row">
            <button class="small-btn" onclick="addQuickLink()">Add</button>
            <button class="small-btn" onclick="clearQuickLinks()">Clear All</button>
          </div>
        </div>
      </div>
    </div>

    <div id="planner" class="panel" aria-hidden="true">
      <div class="panel-header" onclick="togglePanel('planner')">
        <div style="width:20px"></div>
        <div class="title">Planner (Weekly)</div>
        <div class="chev">‚ñæ</div>
      </div>
      <div id="plannerBody" class="panel-body" aria-hidden="true">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <div style="margin-left:auto; font-size:13px; opacity:0.9">Week: Sunday ‚Üí Saturday</div>
        </div>
        <div id="plannerGrid" style="margin-top:10px;"></div>
        <div id="palette" aria-hidden="false">
          <div style="font-weight:600; margin-top:8px;">Palette (saved colors)</div>
          <div class="palette-row" id="paletteRow"></div>
          <div id="addColorForm" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
            <input type="text" id="paletteLabel" placeholder="Label (e.g. school)">
            <input type="color" id="paletteColor" value="#ffd166">
            <button class="small-btn" onclick="addPaletteColor()">Save color</button>
            <button class="small-btn" onclick="clearPalette()">Clear Palette</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Left Container (Quote + Timer) -->
  <div id="floatingLeftContainer" class="hidden">
    <!-- Quote Box -->
    <div id="quoteBox">
      <button id="newQuoteBtn" onclick="showNewQuote()">üîÑ</button>
      <div id="quoteText">"Loading wisdom..."</div>
      <div id="quoteAuthor">‚Äî Loading</div>
    </div>

    <!-- Timer -->
    <div id="timerContainer">
      <div id="timerHeader">
        <span id="timerTitle">‚è±Ô∏è Focus Timer</span>
        <button class="hide-btn" onclick="toggleTimerCollapse()">Hide</button>
      </div>
      <div id="timerBody">
        <div id="timerProgress"><div id="timerProgressFill" style="width: 100%"></div></div>
        <div id="timerDisplay">25:00</div>
        <div>
          <input type="number" id="timerMinutes" value="25" min="1" max="120" style="width:60px; text-align:center;"> min
        </div>
        <div style="margin-top:8px;">
          <button class="timer-btn start" onclick="startTimer()">‚ñ∂ Start</button>
          <button class="timer-btn pause" onclick="pauseTimer()">‚è∏ Pause</button>
          <button class="timer-btn reset" onclick="resetTimer()">‚Ü∫ Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- To-do lists -->
  <div id="todo" class="hidden">
    <div id="todoHeader"></div>
    <div class="tabs" id="tabsContainer"></div>
    <div id="listsContainer"></div>
    <div id="background-picker" class="hidden" style="margin-top:12px;">
      <label for="bg-select">Choose Background:</label>
      <select id="bg-select" onchange="changeBackground(this.value)">
        <option value="default">Default</option>
        <option value="linear-gradient(to right, #ff7e5f, #feb47b)">Sunset</option>
        <option value="linear-gradient(to right, #2193b0, #6dd5ed)">Ocean</option>
        <option value="linear-gradient(to right, #0f2027, #203a43, #2c5364)">Galaxy</option>
        <option value="linear-gradient(to right, #ff9a9e, #fad0c4)">Blossom</option>
      </select>
    </div>
    <div style="margin-top:12px">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Task Dialog -->
  <div id="taskDialog" class="hidden" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(6,8,12,0.95); padding:16px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:320px; z-index:999;">
    <h3 id="taskDialogTitle">Add Task</h3>
    <input type="text" id="taskText" placeholder="Task description">
    <label style="font-size:13px; opacity:0.9; display:block; text-align:left; margin-left:4px;">Color (pick or use palette)</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="taskColor" value="#ffd166">
      <div id="taskColorPreview" style="width:34px; height:34px; border-radius:6px; border:2px solid rgba(255,255,255,0.12);"></div>
    </div>
    <div id="dialogPaletteRow" class="palette-row" style="margin-top:8px;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button onclick="closeTaskDialog()">Cancel</button>
      <button onclick="saveTaskFromDialog()" class="list-button">Save</button>
    </div>
  </div>

  <!-- Pet Settings Dialog -->
  <div id="petDialog" class="hidden" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(6,8,12,0.95); padding:16px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); width:320px; z-index:999;">
    <h3>üêæ Pet Settings</h3>
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Pet Name:</label>
    <input type="text" id="petNameInput" placeholder="Name your pet" style="width:100%;">
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Choose Pet:</label>
    <div id="petChoices" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"></div>
    <label style="font-size:13px; display:block; text-align:left; margin:8px 0 4px;">Unlocked Accessories:</label>
    <div id="accessoryChoices" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button onclick="closePetDialog()">Cancel</button>
      <button onclick="savePetSettings()" class="list-button">Save</button>
    </div>
  </div>

<script>
/* ========== UTILITIES ========== */
function $(id){return document.getElementById(id);}
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function getUsers(){ return JSON.parse(localStorage.getItem('users') || '{}'); }
function saveUsers(u){ localStorage.setItem('users', JSON.stringify(u)); }

let currentUser = localStorage.getItem('currentUser') || null;
let currentUserName = null;
let allLists = [];
let activeListIndex = 0;
let pickedBackground = 'default';

// Task timer tracking
let activeTaskTimer = null; // { listIndex, taskIndex, startTime, intervalId }

// Focus timer
let focusTimerInterval = null;
let focusTimerSeconds = 25 * 60;
let focusTimerTotal = 25 * 60;
let focusTimerRunning = false;

// Pet decay interval
let petDecayInterval = null;

/* Hide panels on load */
$('topPanels').classList.add('hidden');
$('quickLinks').classList.add('hidden');
$('planner').classList.add('hidden');
$('petContainer').classList.add('hidden');

/* ========== QUOTES ========== */
const quotes = [
  { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
  { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
  { text: "Done is better than perfect.", author: "Sheryl Sandberg" },
  { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
  { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
  { text: "Your future self is watching you right now through memories.", author: "Aubrey de Grey" },
  { text: "A year from now you'll wish you started today.", author: "Karen Lamb" },
  { text: "Stop waiting for Friday, for summer, for life. Happiness is achieved when you stop waiting and start doing.", author: "Unknown" },
  // Sarcastic ones üòè
  { text: "I'm not procrastinating. I'm doing side quests.", author: "Every gamer ever" },
  { text: "If you think you're too small to make a difference, try sleeping with a mosquito.", author: "Dalai Lama" },
  { text: "The road to success is always under construction.", author: "Lily Tomlin" },
  { text: "I didn't fail. I just found 10,000 ways that won't work.", author: "Thomas Edison" },
  { text: "My to-do list and my 'done' list are in a long-distance relationship.", author: "Everyone" },
  { text: "I'll start being productive tomorrow. Today is still ruined.", author: "You, probably" },
  { text: "Hard work pays off later. Laziness pays off now.", author: "Steven Wright" },
  { text: "I'm on a seafood diet. I see food and I eat it instead of working.", author: "Anonymous" },
  { text: "Do or do not. There is no try. But also, naps.", author: "Tired Yoda" },
  { text: "The only thing standing between you and success is... literally everything else.", author: "Reality" },
  { text: "If at first you don't succeed, redefine success.", author: "Every startup" },
  { text: "I have a lot of potential. I just choose to keep it potential.", author: "Your inner voice" }
];

function showNewQuote(){
  const q = quotes[Math.floor(Math.random() * quotes.length)];
  $('quoteText').textContent = `"${q.text}"`;
  $('quoteAuthor').textContent = `‚Äî ${q.author}`;
}

/* ========== VIRTUAL PET ========== */
const petTypes = ['üê±', 'üê∂', 'üê∞', 'üêª', 'ü¶ä', 'üêº', 'üê∏', 'üêß', 'ü¶Ñ', 'üê≤'];
const accessories = [
  { emoji: '', name: 'None', unlockLevel: 0 },
  { emoji: 'üé©', name: 'Top Hat', unlockLevel: 2 },
  { emoji: 'üëí', name: 'Sun Hat', unlockLevel: 3 },
  { emoji: 'üéÄ', name: 'Bow', unlockLevel: 4 },
  { emoji: 'üëë', name: 'Crown', unlockLevel: 5 },
  { emoji: 'üï∂Ô∏è', name: 'Sunglasses', unlockLevel: 6 },
  { emoji: 'üß¢', name: 'Cap', unlockLevel: 7 },
  { emoji: 'üå∏', name: 'Flower', unlockLevel: 8 },
  { emoji: '‚≠ê', name: 'Star', unlockLevel: 10 }
];

function getPetData(){
  if (!currentUser) return null;
  const users = getUsers();
  if (!users[currentUser]) return null;
  return users[currentUser].pet || { name: 'Pixel', emoji: 'üê±', happiness: 100, xp: 0, level: 1, accessory: '', lastActive: Date.now() };
}

function savePetData(pet){
  if (!currentUser) return;
  const users = getUsers();
  if (!users[currentUser]) return;
  users[currentUser].pet = pet;
  saveUsers(users);
}

function renderPet(){
  const pet = getPetData();
  if (!pet) return;
  
  $('petEmoji').textContent = pet.emoji || 'üê±';
  $('petAccessory').textContent = pet.accessory || '';
  $('petName').textContent = pet.name || 'Pixel';
  $('petLevel').textContent = `Level ${pet.level} ‚Ä¢ ${pet.xp} XP`;
  $('happinessFill').style.width = `${pet.happiness}%`;
  
  const petDisplay = $('petDisplay');
  petDisplay.classList.remove('pet-sad', 'pet-bounce');
  
  if (pet.happiness >= 70) {
    $('petMood').textContent = 'üòä Happy!';
  } else if (pet.happiness >= 40) {
    $('petMood').textContent = 'üòê Okay...';
  } else if (pet.happiness >= 20) {
    $('petMood').textContent = 'üò¢ Sad...';
    petDisplay.classList.add('pet-sad');
  } else {
    $('petMood').textContent = 'üíÄ Dying! Do tasks!';
    petDisplay.classList.add('pet-sad');
  }
}

function petGainXP(amount){
  const pet = getPetData();
  if (!pet) return;
  
  pet.xp += amount;
  pet.happiness = Math.min(100, pet.happiness + 10);
  pet.lastActive = Date.now();
  
  // Level up check (100 XP per level)
  const newLevel = Math.floor(pet.xp / 100) + 1;
  if (newLevel > pet.level) {
    pet.level = newLevel;
    alert(`üéâ ${pet.name} leveled up to Level ${pet.level}!`);
  }
  
  savePetData(pet);
  renderPet();
  
  // Bounce animation
  const petDisplay = $('petDisplay');
  petDisplay.classList.remove('pet-bounce');
  void petDisplay.offsetWidth;
  petDisplay.classList.add('pet-bounce');
}

function petDecay(){
  const pet = getPetData();
  if (!pet) return;
  
  // Decay happiness over time if no tasks completed
  pet.happiness = Math.max(0, pet.happiness - 2);
  savePetData(pet);
  renderPet();
}

function startPetDecay(){
  if (petDecayInterval) clearInterval(petDecayInterval);
  // Decay every 5 minutes
  petDecayInterval = setInterval(petDecay, 5 * 60 * 1000);
}

function openPetSettings(){
  const pet = getPetData();
  if (!pet) return;
  
  $('petNameInput').value = pet.name || 'Pixel';
  
  // Render pet choices
  const petChoicesDiv = $('petChoices');
  petChoicesDiv.innerHTML = '';
  petTypes.forEach(emoji => {
    const btn = document.createElement('button');
    btn.textContent = emoji;
    btn.style.fontSize = '24px';
    btn.style.padding = '8px';
    btn.style.background = pet.emoji === emoji ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      petChoicesDiv.querySelectorAll('button').forEach(b => b.style.background = 'rgba(255,255,255,0.1)');
      btn.style.background = 'rgba(255,255,255,0.3)';
      btn.dataset.selected = 'true';
    };
    if (pet.emoji === emoji) btn.dataset.selected = 'true';
    petChoicesDiv.appendChild(btn);
  });
  
  // Render accessory choices
  const accDiv = $('accessoryChoices');
  accDiv.innerHTML = '';
  accessories.forEach(acc => {
    const btn = document.createElement('button');
    btn.textContent = acc.emoji || '‚ùå';
    btn.title = acc.name + (acc.unlockLevel > pet.level ? ` (Unlock at Lvl ${acc.unlockLevel})` : '');
    btn.style.fontSize = '20px';
    btn.style.padding = '6px';
    btn.style.background = pet.accessory === acc.emoji ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
    btn.style.border = 'none';
    btn.style.borderRadius = '8px';
    btn.style.cursor = acc.unlockLevel <= pet.level ? 'pointer' : 'not-allowed';
    btn.style.opacity = acc.unlockLevel <= pet.level ? '1' : '0.4';
    btn.disabled = acc.unlockLevel > pet.level;
    btn.onclick = () => {
      if (acc.unlockLevel > pet.level) return;
      accDiv.querySelectorAll('button').forEach(b => b.style.background = 'rgba(255,255,255,0.1)');
      btn.style.background = 'rgba(255,255,255,0.3)';
      btn.dataset.selected = 'true';
      btn.dataset.emoji = acc.emoji;
    };
    if (pet.accessory === acc.emoji) {
      btn.dataset.selected = 'true';
      btn.dataset.emoji = acc.emoji;
    }
    accDiv.appendChild(btn);
  });
  
  $('petDialog').classList.remove('hidden');
}

function closePetDialog(){
  $('petDialog').classList.add('hidden');
}

function savePetSettings(){
  const pet = getPetData();
  if (!pet) return;
  
  pet.name = $('petNameInput').value.trim() || 'Pixel';
  
  const selectedPet = $('petChoices').querySelector('[data-selected="true"]');
  if (selectedPet) pet.emoji = selectedPet.textContent;
  
  const selectedAcc = $('accessoryChoices').querySelector('[data-selected="true"]');
  if (selectedAcc) pet.accessory = selectedAcc.dataset.emoji || '';
  
  savePetData(pet);
  renderPet();
  closePetDialog();
}

/* ========== FOCUS TIMER ========== */
function updateTimerDisplay(){
  const mins = Math.floor(focusTimerSeconds / 60);
  const secs = focusTimerSeconds % 60;
  $('timerDisplay').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  const progress = (focusTimerSeconds / focusTimerTotal) * 100;
  $('timerProgressFill').style.width = `${progress}%`;
}

function startTimer(){
  if (focusTimerRunning) return;
  
  if (focusTimerSeconds <= 0) {
    focusTimerTotal = parseInt($('timerMinutes').value) * 60 || 25 * 60;
    focusTimerSeconds = focusTimerTotal;
  }
  
  focusTimerRunning = true;
  focusTimerInterval = setInterval(() => {
    focusTimerSeconds--;
    updateTimerDisplay();
    
    if (focusTimerSeconds <= 0) {
      clearInterval(focusTimerInterval);
      focusTimerRunning = false;
      playChime();
      alert('‚è∞ Timer complete! Great focus session!');
      petGainXP(20); // Bonus XP for completing a focus session
    }
  }, 1000);
}

function pauseTimer(){
  if (focusTimerInterval) {
    clearInterval(focusTimerInterval);
    focusTimerRunning = false;
  }
}

function resetTimer(){
  pauseTimer();
  focusTimerTotal = parseInt($('timerMinutes').value) * 60 || 25 * 60;
  focusTimerSeconds = focusTimerTotal;
  updateTimerDisplay();
}

function playChime(){
  // Create a pleasant chime sound using Web Audio API
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Play a sequence of tones for a nice chime effect
    const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
    
    frequencies.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      
      const startTime = ctx.currentTime + (i * 0.15);
      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.8);
      
      osc.start(startTime);
      osc.stop(startTime + 0.8);
    });
    
    // Also play a second round slightly delayed for a richer sound
    setTimeout(() => {
      try {
        const ctx2 = new (window.AudioContext || window.webkitAudioContext)();
        frequencies.forEach((freq, i) => {
          const osc = ctx2.createOscillator();
          const gain = ctx2.createGain();
          osc.connect(gain);
          gain.connect(ctx2.destination);
          osc.frequency.value = freq;
          osc.type = 'triangle';
          
          const startTime = ctx2.currentTime + (i * 0.15);
          gain.gain.setValueAtTime(0, startTime);
          gain.gain.linearRampToValueAtTime(0.15, startTime + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1);
          
          osc.start(startTime);
          osc.stop(startTime + 1);
        });
      } catch(e) {}
    }, 600);
    
  } catch(e) { /* Audio not supported */ }
}

/* ========== TIMER COLLAPSE/HIDE ========== */
function toggleTimerCollapse(){
  const container = $('timerContainer');
  const header = $('timerHeader');
  const hideBtn = container.querySelector('.hide-btn');
  
  if (container.classList.contains('collapsed')) {
    container.classList.remove('collapsed');
    header.classList.remove('collapsed-header');
    hideBtn.textContent = 'Hide';
  } else {
    container.classList.add('collapsed');
    header.classList.add('collapsed-header');
    hideBtn.textContent = 'Show';
  }
}

/* ========== QUICK LINKS HIDE/SHOW ========== */
function hideQuickLinks(){
  $('quickLinks').classList.add('hidden');
  $('quickLinksToggle').style.display = 'block';
}

function showQuickLinks(){
  $('quickLinks').classList.remove('hidden');
  $('quickLinksToggle').style.display = 'none';
}

/* ========== TASK TIME TRACKING ========== */
function formatTaskTime(seconds){
  if (seconds < 60) return `${seconds}s`;
  if (seconds < 3600) return `${Math.floor(seconds/60)}m ${seconds%60}s`;
  return `${Math.floor(seconds/3600)}h ${Math.floor((seconds%3600)/60)}m`;
}

function startTaskTimer(listIndex, taskIndex){
  // Stop any existing timer
  stopTaskTimer();
  
  activeTaskTimer = {
    listIndex,
    taskIndex,
    startTime: Date.now(),
    intervalId: setInterval(() => renderLists(), 1000)
  };
  renderLists();
}

function stopTaskTimer(){
  if (!activeTaskTimer) return;
  
  clearInterval(activeTaskTimer.intervalId);
  
  // Calculate time spent
  const elapsed = Math.floor((Date.now() - activeTaskTimer.startTime) / 1000);
  const task = allLists[activeTaskTimer.listIndex]?.tasks?.[activeTaskTimer.taskIndex];
  if (task) {
    task.timeSpent = (task.timeSpent || 0) + elapsed;
    saveAllLists();
  }
  
  activeTaskTimer = null;
  renderLists();
}

function getActiveTaskTime(){
  if (!activeTaskTimer) return 0;
  return Math.floor((Date.now() - activeTaskTimer.startTime) / 1000);
}

/* ========== GRADIENT SELECTION ========== */
const gradientEls = Array.from(document.querySelectorAll('.gradient-option'));
function setPickedBgValue(val){
  pickedBackground = val;
  gradientEls.forEach(el => el.classList.toggle('selected', el.getAttribute('data-bg') === val));
  applyBackgroundPreview(val);
}
function applyBackgroundPreview(val) {
  if (val === 'default') {
    document.body.style.background = 'linear-gradient(135deg, #5b00ff, #ff0066, #00f2ff)';
    document.body.style.backgroundSize = '400% 400%';
    document.body.style.animation = 'gradientMove 12s ease infinite';
  } else {
    document.body.style.background = val;
    document.body.style.backgroundSize = '';
    document.body.style.animation = '';
  }
}
gradientEls.forEach(el => el.addEventListener('click', ()=> setPickedBgValue(el.getAttribute('data-bg'))));
function useDefaultNow(){ setPickedBgValue('default'); }

/* ========== PANEL TOGGLE ========== */
function togglePanel(panelId){
  const panel = $(panelId);
  const body = $(panelId + 'Body');
  if (!panel || !body) return;
  const open = body.classList.contains('open');
  if (open) {
    body.style.maxHeight = body.scrollHeight + 'px';
    requestAnimationFrame(()=> {
      body.style.maxHeight = '0px';
      body.classList.remove('open');
      panel.classList.remove('open');
      body.setAttribute('aria-hidden','true');
    });
  } else {
    body.classList.add('open');
    panel.classList.add('open');
    body.setAttribute('aria-hidden','false');
    body.style.maxHeight = body.scrollHeight + 'px';
    setTimeout(()=> { if (body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }, 330);
  }
}

/* ========== TOP PANELS VISIBILITY ========== */
function checkTopPanelsVisibility(){
  const top = $('topPanels');
  const quick = $('quickLinks');
  const plan = $('planner');
  const pet = $('petContainer');
  const floating = $('floatingLeftContainer');

  if (!currentUser) {
    top?.classList.add('hidden'); top?.setAttribute('aria-hidden','true');
    quick?.classList.add('hidden'); quick?.setAttribute('aria-hidden','true');
    plan?.classList.add('hidden'); plan?.setAttribute('aria-hidden','true');
    pet?.classList.add('hidden');
    floating?.classList.add('hidden');
    $('quickLinksToggle').style.display = 'none';
    return;
  }

  top?.classList.remove('hidden'); top?.setAttribute('aria-hidden','false');
  quick?.classList.remove('hidden'); quick?.setAttribute('aria-hidden','false');
  plan?.classList.remove('hidden'); plan?.setAttribute('aria-hidden','false');
  pet?.classList.remove('hidden');
  floating?.classList.remove('hidden');
}

/* ========== LOAD SESSION ========== */
if (currentUser) {
  const usersTemp = getUsers();
  if (usersTemp[currentUser]) {
    currentUserName = usersTemp[currentUser].username || null;
    loadAllLists();
    showTodo();
    renderLists();
    renderQuickLinks();
    renderPlanner();
    renderPet();
    checkTopPanelsVisibility();
    startPetDecay();
  } else {
    localStorage.removeItem('currentUser');
    currentUser = null;
  }
}

/* ========== ACCOUNTS ========== */
function createAccount(){
  const user = $('username').value.trim();
  const pass = $('password').value.trim();
  if (!user || !pass) { alert('Please fill both username and password'); return; }
  
  const usersRaw = localStorage.getItem('users');
  const users = usersRaw ? JSON.parse(usersRaw) : {};
  
  const existingUsernames = Object.keys(users);
  for (let i = 0; i < existingUsernames.length; i++) {
    if (existingUsernames[i] === user) {
      alert('Username is in use, please choose another one');
      return;
    }
  }
  
  users[user] = {
    username: user,
    password: pass,
    lists: [{ name: 'My First List', tasks: [] }],
    background: pickedBackground,
    quickLinks: [],
    planner: [],
    palette: [],
    pet: { name: 'Pixel', emoji: 'üê±', happiness: 100, xp: 0, level: 1, accessory: '', lastActive: Date.now() }
  };
  localStorage.setItem('users', JSON.stringify(users));
  localStorage.setItem('currentUser', user);
  currentUser = user; 
  currentUserName = user;
  loadAllLists();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
  renderPet();
  checkTopPanelsVisibility();
  startPetDecay();
}

function showLogin(){ $('signup').classList.add('hidden'); $('login').classList.remove('hidden'); }
function showSignup(){ $('login').classList.add('hidden'); $('signup').classList.remove('hidden'); }

function login(){
  const userInput = $('loginUsername').value.trim();
  const pass = $('loginPassword').value.trim();
  const users = getUsers();
  
  if (!users[userInput] || users[userInput].password !== pass) { 
    alert('Invalid username or password'); 
    return; 
  }
  
  localStorage.setItem('currentUser', userInput);
  currentUser = userInput; 
  currentUserName = users[userInput].username || userInput;
  loadAllLists();
  showTodo();
  renderLists();
  renderQuickLinks();
  renderPlanner();
  renderPet();
  checkTopPanelsVisibility();
  startPetDecay();
  showNewQuote();
}

/* ========== SHOW TODO ========== */
function showTodo(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return;
  const user = users[currentUser];
  applyBackgroundPreview(user.background || 'default');
  $('signup').classList.add('hidden');
  $('login').classList.add('hidden');
  $('todo').classList.remove('hidden');

  const displayName = currentUserName || currentUser;
  $('todoHeader').innerHTML = `
    <h1>Welcome, ${escapeHtml(displayName)}!</h1>
    <div style="margin-top:8px">
      <button onclick="createNewList()" class="list-button">+ New To-Do List</button>
      <button class="control-small" onclick="openBackgroundPicker()">Change background</button>
    </div>
  `;
  
  showNewQuote();
  resetTimer();
}

/* ========== BACKGROUND PICKER ========== */
function openBackgroundPicker(){
  const picker = $('background-picker');
  if(picker.classList.contains('hidden')){
    picker.classList.remove('hidden');
  } else {
    picker.classList.add('hidden');
  }
}

function changeBackground(value){
  applyBackgroundPreview(value);
  const users = getUsers();
  if (currentUser && users[currentUser]) {
    users[currentUser].background = value;
    saveUsers(users);
  }
}

/* ========== QUICK LINKS ========== */
function renderQuickLinks(){
  const listEl = $('quickLinksList');
  if (!listEl) return;
  listEl.innerHTML = '';

  if (!currentUser) {
    checkTopPanelsVisibility();
    return;
  }

  const users = getUsers();
  const links = (users[currentUser] && users[currentUser].quickLinks) || [];
  links.forEach((link, i) => {
    const li = document.createElement('li');
    const nameDisplay = link.name ? (link.name.length > 36 ? (link.name.slice(0,33) + '...') : link.name) : (link.url.length > 36 ? (link.url.slice(0,33) + '...') : link.url);
    li.innerHTML = `<div style="display:flex; flex-direction:column; gap:4px;"><a href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(nameDisplay)}</a><span style="font-size:12px; opacity:0.9;">${escapeHtml(link.url)}</span></div>
      <div>
        <button class="small-btn" onclick="editQuickLink(${i})" title="Edit link">‚úèÔ∏è</button>
        <button class="small-btn" onclick="removeQuickLink(${i})" title="Remove link">üóë</button>
      </div>`;
    listEl.appendChild(li);
  });

  checkTopPanelsVisibility();
}

function addQuickLink(){
  const name = $('quickLinkName').value.trim();
  let url = $('quickLinkURL').value.trim();
  if (!name || !url) { alert('Please enter both a name and a URL'); return; }
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return alert('No user session');
  users[currentUser].quickLinks = users[currentUser].quickLinks || [];
  users[currentUser].quickLinks.push({ name, url });
  saveUsers(users);
  $('quickLinkName').value=''; $('quickLinkURL').value='';
  renderQuickLinks();
}

function editQuickLink(index){
  const users = getUsers();
  if (!currentUser || !users[currentUser] || !users[currentUser].quickLinks) return;
  const link = users[currentUser].quickLinks[index];
  if (!link) return;
  const newName = prompt('Edit link name:', link.name || '') || link.name || '';
  let newUrl = prompt('Edit link URL:', link.url || '') || link.url || '';
  if (!newName || !newUrl) return alert('Name and URL cannot be empty');
  if (!/^https?:\/\//i.test(newUrl)) newUrl = 'https://' + newUrl;
  users[currentUser].quickLinks[index] = { name: newName.trim(), url: newUrl.trim() };
  saveUsers(users);
  renderQuickLinks();
}

function removeQuickLink(index){
  const users = getUsers();
  if (!currentUser || !users[currentUser] || !users[currentUser].quickLinks) return;
  users[currentUser].quickLinks.splice(index,1);
  saveUsers(users);
  renderQuickLinks();
}

function clearQuickLinks(){
  if (!confirm('Clear all quick links for this account?')) return;
  const users = getUsers();
  if (!currentUser || !users[currentUser]) return;
  users[currentUser].quickLinks = [];
  saveUsers(users);
  renderQuickLinks();
}

/* ========== PLANNER ========== */
function formatDate(d) {
  const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const day = days[d.getDay()];
  const month = months[d.getMonth()];
  const date = d.getDate();
  const suffix = (date % 10 === 1 && date !== 11) ? "st" :
                 (date % 10 === 2 && date !== 12) ? "nd" :
                 (date % 10 === 3 && date !== 13) ? "rd" : "th";
  return `${day}, ${month} ${date}${suffix}`;
}

function renderPlanner(){
  const plannerDiv = $('planner');
  const grid = $('plannerGrid');
  const paletteRow = $('paletteRow');
  if (!grid || !paletteRow) return;

  if (!currentUser) {
    checkTopPanelsVisibility();
    return;
  }

  grid.innerHTML = '';

  const today = new Date();
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay());
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startOfWeek);
    d.setDate(startOfWeek.getDate() + i);
    weekDates.push(d);
  }

  const users = getUsers();
  const user = users[currentUser] || { planner: [], palette: [] };
  const tasks = user.planner || [];
  const palette = user.palette || [];

  for (let day = 0; day < 7; day++){
    const col = document.createElement('div');
    col.className = 'day-col';

    const d = weekDates[day];
    const dayLabel = formatDate(d);
    const header = document.createElement('div');
    header.className = 'day-header';
    header.textContent = dayLabel;
    col.appendChild(header);

    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const date = String(d.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${date}`;
    
    const dayTasks = tasks.filter(t => t.dueDate === dateStr);

    dayTasks.forEach((task) => {
      const pill = document.createElement('div');
      pill.className = 'task-pill';
      pill.style.background = task.color || '#ffd166';
      pill.style.color = readableTextColor(task.color || '#ffd166');
      pill.title = task.text;

      const label = document.createElement('div');
      label.className = 'task-label';
      label.textContent = task.text;

      const controls = document.createElement('div');
      controls.style.display='flex'; controls.style.gap='6px';
      const editBtn = document.createElement('button'); editBtn.textContent='‚úèÔ∏è'; editBtn.className='small-btn';
      editBtn.onclick = ()=> openEditTaskDialog(task.id);
      const delBtn = document.createElement('button'); delBtn.textContent='üóë'; delBtn.className='small-btn';
      delBtn.onclick = ()=> { if(confirm('Delete this task?')) { removePlannerById(task.id); } };
      controls.appendChild(editBtn); controls.appendChild(delBtn);

      pill.appendChild(label);
      pill.appendChild(controls);
      col.appendChild(pill);
    });

    if(dayTasks.length === 0){
      const empty = document.createElement('div');
      empty.style.opacity='0.7';
      empty.style.fontSize='13px';
      empty.textContent = '‚Äî no tasks ‚Äî';
      col.appendChild(empty);
    }

    grid.appendChild(col);
  }

  // Render palette WITH LABELS
  paletteRow.innerHTML = '';
  if (palette.length === 0) {
    paletteRow.innerHTML = '<span style="font-size:12px; opacity:0.7;">No saved colors yet</span>';
  } else {
    palette.forEach(p => {
      const container = document.createElement('div');
      container.className = 'swatch-container';
      
      const s = document.createElement('div');
      s.className = 'swatch';
      s.title = p.label || '';
      s.style.background = p.color || '#fff';
      s.onclick = ()=> { 
        $('taskColor').value = p.color; 
        $('taskColorPreview').style.background = p.color; 
      };
      
      const labelEl = document.createElement('div');
      labelEl.className = 'swatch-label';
      labelEl.textContent = p.label || '';
      
      container.appendChild(s);
      container.appendChild(labelEl);
      paletteRow.appendChild(container);
    });
  }

  checkTopPanelsVisibility();
}

function readableTextColor(hex){
  try{
    const c = hex.replace('#','');
    const r = parseInt(c.substring(0,2),16);
    const g = parseInt(c.substring(2,4),16);
    const b = parseInt(c.substring(4,6),16);
    const lum = 0.2126*r + 0.7152*g + 0.0722*b;
    return lum > 150 ? '#071019' : '#ffffff';
  } catch(e){ return '#071019'; }
}

function addPaletteColor(){
  const labelInput = $('paletteLabel');
  const colorInput = $('paletteColor');
  const label = labelInput.value.trim();
  const color = colorInput.value;
  
  if (!label) { alert('Label required for saved color'); return; }
  if (!currentUser) { alert('No user session'); return; }
  
  const users = getUsers();
  if (!users[currentUser]) { alert('User not found'); return; }
  
  users[currentUser].palette = users[currentUser].palette || [];
  users[currentUser].palette.push({ id: Date.now() + Math.random(), label: label, color: color });
  saveUsers(users);
  labelInput.value = '';
  renderPlanner();
}

function clearPalette(){
  if (!confirm('Clear saved palette for this account?')) return;
  const users = getUsers();
  if (!users[currentUser]) return;
  users[currentUser].palette = [];
  saveUsers(users);
  renderPlanner();
}

/* ========== TASK DIALOG ========== */
function renderDialogPalette(){
  const dialogPaletteRow = $('dialogPaletteRow');
  if (!dialogPaletteRow) return;
  dialogPaletteRow.innerHTML = '';
  
  const users = getUsers();
  const user = users[currentUser] || {};
  const palette = user.palette || [];
  
  if (palette.length === 0) {
    dialogPaletteRow.innerHTML = '<span style="font-size:12px; opacity:0.7;">No saved colors yet</span>';
    return;
  }
  
  palette.forEach(p => {
    const container = document.createElement('div');
    container.className = 'swatch-container';
    
    const s = document.createElement('div');
    s.className = 'swatch';
    s.title = p.label || '';
    s.style.background = p.color || '#fff';
    s.onclick = ()=> { 
      $('taskColor').value = p.color; 
      $('taskColorPreview').style.background = p.color; 
    };
    
    const labelEl = document.createElement('div');
    labelEl.className = 'swatch-label';
    labelEl.textContent = p.label || '';
    
    container.appendChild(s);
    container.appendChild(labelEl);
    dialogPaletteRow.appendChild(container);
  });
}

function openAddTaskDialog(){
  $('taskDialogTitle').textContent = 'Add Task';
  $('taskText').value = '';
  $('taskColor').value = '#ffd166';
  $('taskColorPreview').style.background = $('taskColor').value;
  $('taskDialog').dataset.editId = '';
  renderDialogPalette();
  $('taskDialog').classList.remove('hidden');
}

function openEditTaskDialog(taskId){
  const users = getUsers();
  const user = users[currentUser] || {};
  const tasks = user.planner || [];
  const task = tasks.find(t => t.id === taskId);
  if (!task) return alert('Task not found');
  $('taskDialogTitle').textContent = 'Edit Task';
  $('taskText').value = task.text || '';
  $('taskColor').value = task.color || '#ffd166';
  $('taskColorPreview').style.background = $('taskColor').value;
  $('taskDialog').dataset.editId = String(taskId);
  renderDialogPalette();
  $('taskDialog').classList.remove('hidden');
}

function closeTaskDialog(){ $('taskDialog').classList.add('hidden'); $('taskDialog').dataset.editId=''; }

$('taskColor')?.addEventListener?.('input', ()=> { $('taskColorPreview').style.background = $('taskColor').value; });

function saveTaskFromDialog(){
  const text = $('taskText').value.trim();
  if (!text) return alert('Please enter task text');
  const color = $('taskColor').value || '#ffd166';
  const users = getUsers();
  users[currentUser] = users[currentUser] || {};
  users[currentUser].planner = users[currentUser].planner || [];

  const editId = $('taskDialog').dataset.editId;
  if (editId) {
    const idx = users[currentUser].planner.findIndex(t=>String(t.id)===String(editId));
    if (idx >= 0) {
      const oldTask = users[currentUser].planner[idx];
      const oldText = oldTask.text;
      const oldDueDate = oldTask.dueDate;
      
      users[currentUser].planner[idx].text = text;
      users[currentUser].planner[idx].color = color;
      
      if(oldDueDate){
        allLists.forEach(list => {
          list.tasks.forEach(t => {
            if(t.dueDate === oldDueDate && t.text === oldText){
              t.text = text;
            }
          });
        });
        saveAllLists();
      }
    }
  } else {
    users[currentUser].planner.push({ id: Date.now() + Math.random(), text, color });
  }
  saveUsers(users);
  closeTaskDialog();
  renderPlanner();
  renderLists();
}

function removePlannerById(id){
  const users = getUsers();
  if (!users[currentUser] || !users[currentUser].planner) return;
  
  const plannerTask = users[currentUser].planner.find(t => String(t.id) === String(id));
  
  users[currentUser].planner = users[currentUser].planner.filter(t => String(t.id) !== String(id));
  saveUsers(users);
  
  if(plannerTask && plannerTask.dueDate){
    allLists.forEach(list => {
      list.tasks = list.tasks.filter(t => !(t.dueDate === plannerTask.dueDate && t.text === plannerTask.text));
    });
    saveAllLists();
    renderLists();
  }
  
  renderPlanner();
}

/* ========== LISTS ========== */
function saveAllLists(){
  if (!currentUser) return;
  const users = getUsers();
  if (users[currentUser]) {
    users[currentUser].lists = allLists;
    saveUsers(users);
  }
}

function loadAllLists(){
  const users = getUsers();
  if (!currentUser || !users[currentUser]) { allLists = []; return; }
  allLists = users[currentUser].lists || [];
  allLists = allLists.map(l => (typeof l === 'string' ? { name: l, tasks: [] } : (l.name ? l : { name: 'Untitled', tasks: l.tasks || [] })));
  activeListIndex = 0;
}

function renderLists(){
  renderTabs();
  renderActiveList();
}

function renderTabs(){
  const tabs = $('tabsContainer'); tabs.innerHTML='';
  allLists.forEach((list,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i===activeListIndex ? ' active' : '');
    btn.textContent = list.name || `List ${i+1}`;
    btn.onclick = ()=>{ activeListIndex = i; renderLists(); };
    tabs.appendChild(btn);
    const renameBtn = document.createElement('button'); renameBtn.className='control-small'; renameBtn.textContent='‚úèÔ∏è';
    renameBtn.onclick = (e)=>{ e.stopPropagation(); renameList(i); };
    tabs.appendChild(renameBtn);
    const delBtn = document.createElement('button'); delBtn.className='control-small'; delBtn.textContent='üóë';
    delBtn.onclick = (e)=>{ e.stopPropagation(); confirmDeleteList(i); };
    tabs.appendChild(delBtn);
  });
}

function renderActiveList(){
  const container = $('listsContainer'); container.innerHTML='';
  if (allLists.length === 0){
    container.innerHTML = `<div style="padding:20px; border-radius:12px; background: rgba(0,0,0,0.15)">
      <h2>No To-Do Lists Yet üòé</h2>
      <p>Click "+ New To-Do List" to start.</p>
    </div>`;
    return;
  }
  const index = activeListIndex;
  const list = allLists[index];
  const listDiv = document.createElement('div');
  listDiv.innerHTML = `
    <h2 style="margin-bottom:6px">${escapeHtml(list.name)}</h2>
    <div style="margin-bottom:8px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
      <input type="text" id="newTask_${index}" placeholder="Add a task..." style="flex:1; min-width:150px;">
      <input type="date" id="newTaskDate_${index}">
      <button onclick="addTask(${index})">Add</button>
    </div>
    <ul id="list_${index}"></ul>
  `;
  container.appendChild(listDiv);
  const ul = $('list_'+index);
  
  list.tasks.forEach((task, tIdx)=>{
    const li = document.createElement('li');
    const dateLabel = task.dueDate ? `<span style="font-size:12px; opacity:0.9; margin-right:8px;">${escapeHtml(task.dueDate)}</span>` : '';
    const totalTime = task.timeSpent ? `<span class="task-total-time">Total: ${formatTaskTime(task.timeSpent)}</span>` : '';
    
    // Check if this task has active timer
    const isTimerActive = activeTaskTimer && activeTaskTimer.listIndex === index && activeTaskTimer.taskIndex === tIdx;
    const currentTime = isTimerActive ? getActiveTaskTime() + (task.timeSpent || 0) : (task.timeSpent || 0);
    
    li.innerHTML = `
      <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${tIdx})">
      <input type="text" value="${escapeHtml(task.text)}" onchange="editTask(${tIdx}, this.value)" style="text-decoration: ${task.done ? 'line-through' : 'none'}; margin-left:8px; flex:1; min-width:100px;">
      ${dateLabel}
      <div class="task-timer">
        <span class="task-time-display">${formatTaskTime(currentTime)}</span>
        ${isTimerActive 
          ? `<button class="task-timer-btn active" onclick="stopTaskTimer()">‚èπ</button>`
          : `<button class="task-timer-btn" onclick="startTaskTimer(${index}, ${tIdx})">‚ñ∂</button>`
        }
      </div>
      <button onclick="deleteTask(${index}, ${tIdx})">üóëÔ∏è</button>
    `;
    ul.appendChild(li);
  });
}

function createNewList(){ allLists.push({ name:`List ${allLists.length+1}`, tasks:[] }); saveAllLists(); activeListIndex = allLists.length-1; renderLists(); }
function renameList(listIndex){ const newName = prompt("New name:", allLists[listIndex].name || `List ${listIndex+1}`); if (newName && newName.trim()!==""){ allLists[listIndex].name=newName.trim(); saveAllLists(); renderLists(); } }
function confirmDeleteList(listIndex){ if(!confirm("Delete this list?")) return; allLists.splice(listIndex,1); if(allLists.length===0) activeListIndex=0; else if(activeListIndex>=allLists.length) activeListIndex=allLists.length-1; saveAllLists(); renderLists(); }

function addTask(listIndex){
  const input = $('newTask_'+listIndex);
  const dateInput = $('newTaskDate_'+listIndex);
  const text = input.value.trim();
  const dueDate = dateInput ? dateInput.value : '';

  if (!text) return alert("Please enter a task!");

  allLists[listIndex].tasks.push({ text, done:false, dueDate: dueDate || undefined, timeSpent: 0 });

  input.value = "";
  if(dateInput) dateInput.value = "";

  if(dueDate && currentUser){
    const users = getUsers();
    users[currentUser] = users[currentUser] || {};
    users[currentUser].planner = users[currentUser].planner || [];

    users[currentUser].planner.push({
      id: Date.now() + Math.random(),
      text,
      dueDate,
      color: '#ffd166'
    });

    saveUsers(users);
    renderPlanner();
  }

  saveAllLists();
  renderLists();
}

function toggleTask(taskIndex){ 
  const task = allLists[activeListIndex].tasks[taskIndex];
  task.done = !task.done;
  
  // If completing a task, stop its timer and give pet XP
  if (task.done) {
    if (activeTaskTimer && activeTaskTimer.listIndex === activeListIndex && activeTaskTimer.taskIndex === taskIndex) {
      stopTaskTimer();
    }
    petGainXP(25); // XP for completing a task
  }
  
  saveAllLists(); 
  renderLists(); 
}

function editTask(taskIndex, newText){
  const task = allLists[activeListIndex].tasks[taskIndex];
  const oldText = task.text;
  
  if(currentUser && task.dueDate){
    const users = getUsers();
    const user = users[currentUser];
    if(user && user.planner){
      const plannerTask = user.planner.find(p => p.dueDate === task.dueDate && p.text === oldText);
      if(plannerTask) plannerTask.text = newText;
      saveUsers(users);
      renderPlanner();
    }
  }
  
  task.text = newText;
  saveAllLists();
}

function deleteTask(listIndex, taskIndex) {
  if (allLists[listIndex] && allLists[listIndex].tasks && allLists[listIndex].tasks[taskIndex] !== undefined) {
    const task = allLists[listIndex].tasks[taskIndex];
    
    // Stop timer if active on this task
    if (activeTaskTimer && activeTaskTimer.listIndex === listIndex && activeTaskTimer.taskIndex === taskIndex) {
      stopTaskTimer();
    }

    allLists[listIndex].tasks.splice(taskIndex, 1);
    saveAllLists();

    if (currentUser && task && task.dueDate) {
      const users = getUsers();
      const user = users[currentUser];
      if (user && user.planner) {
        user.planner = user.planner.filter(
          (p) => p.dueDate !== task.dueDate || p.text !== task.text
        );
        saveUsers(users);
      }
    }

    requestAnimationFrame(() => {
      renderLists();
      renderPlanner();
    });
  }
}

/* ========== LOGOUT ========== */
function logout(){
  stopTaskTimer();
  saveAllLists();
  if (petDecayInterval) clearInterval(petDecayInterval);
  localStorage.removeItem('currentUser');
  currentUser = null; currentUserName = null; allLists = []; activeListIndex = 0;
  setPickedBgValue('default');
  $('todo').classList.add('hidden'); 
  $('login').classList.remove('hidden');
  $('listsContainer').innerHTML=''; 
  $('tabsContainer').innerHTML=''; 
  $('todoHeader').innerHTML='';
  $('background-picker')?.classList.add('hidden');
  $('topPanels')?.classList.add('hidden'); 
  $('topPanels')?.setAttribute('aria-hidden','true');
  $('quickLinks')?.classList.add('hidden'); 
  $('planner')?.classList.add('hidden');
  $('petContainer')?.classList.add('hidden');
  $('floatingLeftContainer')?.classList.add('hidden');
  $('quickLinksToggle').style.display = 'none';
  checkTopPanelsVisibility();
}

/* ========== INIT ========== */
function initPage(){
  currentUser = localStorage.getItem('currentUser');
  if (currentUser) {
    const users = getUsers();
    if (users[currentUser]) {
      currentUserName = users[currentUser].username || null;
      loadAllLists();
      showTodo();
      renderLists();
      renderQuickLinks();
      renderPlanner();
      renderPet();
      startPetDecay();
    } else {
      localStorage.removeItem('currentUser');
      currentUser = null;
      $('signup').classList.remove('hidden');
    }
  } else {
    $('signup').classList.remove('hidden');
  }
  checkTopPanelsVisibility();
}

window.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
